<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urology Patient Follow-Up</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            background: #45a049;
        }
        
        .btn-danger {
            background: #f44336;
        }
        
        .btn-danger:hover {
            background: #da190b;
        }
        
        .btn-primary {
            background: #2196F3;
        }
        
        .btn-primary:hover {
            background: #1976D2;
        }
        
        .btn-secondary {
            background: #757575;
        }
        
        .btn-secondary:hover {
            background: #616161;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: #667eea;
            outline: none;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .error-message {
            color: #f44336;
            margin-top: 10px;
            padding: 10px;
            background: #ffebee;
            border-radius: 5px;
            display: none;
        }
        
        .success-message {
            color: #4CAF50;
            margin-top: 10px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 5px;
            display: none;
        }
        
        .hidden {
            display: none !important;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #667eea;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .patient-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }
        
        .patient-card h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .patient-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .patient-info span {
            color: #666;
        }
        
        .patient-actions {
            text-align: right;
        }
        
        .search-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .form-container h2 {
            margin-bottom: 25px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-pre-op {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .status-post-op {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .status-discharged {
            background: #e8f5e8;
            color: #388e3c;
        }
        .patient-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .detail-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .detail-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
        }
        
        .detail-section p {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .detail-section strong {
            color: #555;
            display: inline-block;
            min-width: 120px;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .confirmation-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .confirmation-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .confirmation-content h3 {
            color: #f44336;
            margin-bottom: 15px;
        }
        
        .confirmation-content p {
            margin-bottom: 25px;
            color: #666;
        }
        
        .patient-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }
        
        .patient-header h2 {
            margin: 0;
        }
        
        .patient-meta {
            display: flex;
            gap: 20px;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .patient-detail-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .patient-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .patient-meta {
                justify-content: center;
                flex-wrap: wrap;
            }
        }
        .template-btn {
            padding: 8px 12px;
            font-size: 13px;
            border-radius: 5px;
            border: 2px solid #ddd;
            background: white;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .template-btn:hover {
            border-color: #2196F3;
            background: #e3f2fd;
            color: #1976D2;
            transform: translateY(-1px);
        }
        
        .template-btn.active {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
        }
        
        .operative-note-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 5px solid #4CAF50;
        }
        
        .operative-note-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .operative-note-header {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .operative-note-header span {
            color: #555;
            font-size: 14px;
        }
        
        .operative-note-header strong {
            color: #333;
            display: inline-block;
            min-width: 80px;
        }
        
        .operative-section {
            margin-bottom: 20px;
        }
        
        .operative-section h4 {
            color: #2196F3;
            margin-bottom: 10px;
            font-size: 1.1rem;
            border-bottom: 2px solid #e3f2fd;
            padding-bottom: 5px;
        }
        
        .operative-section p {
            color: #666;
            line-height: 1.8;
            white-space: pre-wrap;
        }
        
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px;
        }
        
        .template-preview {
            background: #f0f8ff;
            border: 1px solid #e3f2fd;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }
        
        .template-preview.show {
            display: block;
        }
        
        .template-preview h4 {
            color: #1976D2;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .template-preview p {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        
        .no-operative-notes {
            text-align: center;
            padding: 40px;
            color: #666;
            background: #f9f9f9;
            border-radius: 10px;
            border: 2px dashed #ddd;
        }
        
        .operative-note-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            font-size: 13px;
            color: #888;
        }
        
        .operative-note-actions {
            display: flex;
            gap: 10px;
        }
        
        @media (max-width: 768px) {
            .template-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 6px;
            }
            
            .template-btn {
                padding: 6px 8px;
                font-size: 12px;
            }
            
            .operative-note-header {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .operative-note-meta {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .operative-note-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading">
        <div class="spinner"></div>
        <p>Loading application...</p>
    </div>
    
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container hidden">
        <h2 style="text-align: center; margin-bottom: 30px; color: #333;">
            🏥 Urology Patient System
        </h2>
        <form id="loginForm">
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">
                Login
            </button>
            <div id="loginError" class="error-message"></div>
        </form>
    </div>
    
    <!-- Main Application -->
    <div id="mainApp" class="container hidden">
        <div class="header">
            <h1>🏥 Urology Patient Follow-Up</h1>
            <div class="user-info">
                <div>
                    <span id="userEmail"></span> | 
                    <span id="userRole"></span>
                </div>
                <button id="logoutBtn" class="btn btn-danger">Logout</button>
            </div>
        </div>
        
        <!-- Navigation -->
        <div id="navigation" style="margin-bottom: 20px;">
            <button id="showPatientsBtn" class="btn btn-primary">📋 All Patients</button>
            <button id="showAddPatientBtn" class="btn">➕ Add New Patient</button>
        </div>
        
        <!-- Content Area -->
        <div id="contentArea">
            <!-- Patients List View -->
            <div id="patientsView">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="🔍 Search by name, MRN, or room number...">
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>All Patients (<span id="patientCount">0</span>)</h2>
                    <div>
                        <select id="statusFilter" style="padding: 8px; border-radius: 5px; border: 2px solid #ddd;">
                            <option value="">All Status</option>
                            <option value="pre-op">Pre-Op</option>
                            <option value="post-op">Post-Op</option>
                            <option value="discharged">Discharged</option>
                        </select>
                    </div>
                </div>
                
                <div id="patientsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading patients...</p>
                    </div>
                </div>
            </div>
            
            <!-- Add Patient Form -->
            <div id="addPatientView" class="hidden">
                <div class="form-container">
                    <h2>➕ Add New Patient</h2>
                    <form id="addPatientForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="patientName">Patient Name *</label>
                                <input type="text" id="patientName" required>
                            </div>
                            <div class="form-group">
                                <label for="patientMRN">MRN *</label>
                                <input type="text" id="patientMRN" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="patientAge">Age</label>
                                <input type="number" id="patientAge" min="0" max="150">
                            </div>
                            <div class="form-group">
                                <label for="patientGender">Gender</label>
                                <select id="patientGender">
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="patientPhone">Phone</label>
                                <input type="tel" id="patientPhone">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="roomNumber">Room Number</label>
                                <input type="text" id="roomNumber">
                            </div>
                            <div class="form-group">
                                <label for="admissionDate">Admission Date</label>
                                <input type="date" id="admissionDate">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="presentingComplaint">Presenting Complaint</label>
                            <textarea id="presentingComplaint" placeholder="Chief complaint and history of present illness..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="pmh">Past Medical History</label>
                            <textarea id="pmh" placeholder="Relevant past medical history..."></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="allergies">Allergies</label>
                                <textarea id="allergies" placeholder="Known allergies..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="medications">Current Medications</label>
                                <textarea id="medications" placeholder="Current medications..."></textarea>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="physicalExam">Physical Examination</label>
                            <textarea id="physicalExam" placeholder="Physical examination findings..."></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="imagingSummary">Imaging Summary</label>
                                <textarea id="imagingSummary" placeholder="Imaging results and interpretation..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="labsSummary">Labs Summary</label>
                                <textarea id="labsSummary" placeholder="Laboratory results..."></textarea>
                            </div>
                        </div>
                        
                        <div style="text-align: right; margin-top: 30px;">
                            <button type="button" id="cancelAddPatient" class="btn btn-secondary">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Patient</button>
                        </div>
                        
                        <div id="addPatientError" class="error-message"></div>
                        <div id="addPatientSuccess" class="success-message"></div>
                    </form>
                </div>
            </div>
            <!-- Patient Detail View -->
            <div id="patientDetailView" class="hidden">
                <div class="form-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h2 id="patientDetailName">Patient Details</h2>
                        <div>
                            <button id="editPatientBtn" class="btn btn-secondary">✏️ Edit Patient</button>
                            <button id="backToPatientsBtn" class="btn btn-primary">← Back to List</button>
                        </div>
                    </div>
                    
                    <div id="patientDetailContent">
                        <!-- Patient info will be loaded here -->
                    </div>
                    
                    <!-- Patient Actions -->
                    <div style="margin-top: 30px; text-align: center;">
                        <button id="addOperativeNoteBtn" class="btn btn-primary">🔪 Add Operative Note</button>
                        <button id="addDailyLogBtn" class="btn" style="margin-left: 10px;">📝 Add Daily Log</button>
                        <button id="createDischargeBtn" class="btn" style="margin-left: 10px;">🏠 Discharge Summary</button>
                        <button id="deletePatientBtn" class="btn btn-danger" style="margin-left: 20px;">🗑️ Delete Patient</button>
                    </div>
                </div>
            </div>
            
            <!-- Edit Patient View -->
            <div id="editPatientView" class="hidden">
                <div class="form-container">
                    <h2>✏️ Edit Patient</h2>
                    <form id="editPatientForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editPatientName">Patient Name *</label>
                                <input type="text" id="editPatientName" required>
                            </div>
                            <div class="form-group">
                                <label for="editPatientMRN">MRN *</label>
                                <input type="text" id="editPatientMRN" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editPatientAge">Age</label>
                                <input type="number" id="editPatientAge" min="0" max="150">
                            </div>
                            <div class="form-group">
                                <label for="editPatientGender">Gender</label>
                                <select id="editPatientGender">
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editPatientPhone">Phone</label>
                                <input type="tel" id="editPatientPhone">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editRoomNumber">Room Number</label>
                                <input type="text" id="editRoomNumber">
                            </div>
                            <div class="form-group">
                                <label for="editAdmissionDate">Admission Date</label>
                                <input type="date" id="editAdmissionDate">
                            </div>
                            <div class="form-group">
                                <label for="editPatientStatus">Status</label>
                                <select id="editPatientStatus">
                                    <option value="pre-op">Pre-Op</option>
                                    <option value="post-op">Post-Op</option>
                                    <option value="discharged">Discharged</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editPresentingComplaint">Presenting Complaint</label>
                            <textarea id="editPresentingComplaint" placeholder="Chief complaint and history of present illness..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="editPmh">Past Medical History</label>
                            <textarea id="editPmh" placeholder="Relevant past medical history..."></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editAllergies">Allergies</label>
                                <textarea id="editAllergies" placeholder="Known allergies..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="editMedications">Current Medications</label>
                                <textarea id="editMedications" placeholder="Current medications..."></textarea>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editPhysicalExam">Physical Examination</label>
                            <textarea id="editPhysicalExam" placeholder="Physical examination findings..."></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editImagingSummary">Imaging Summary</label>
                                <textarea id="editImagingSummary" placeholder="Imaging results and interpretation..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="editLabsSummary">Labs Summary</label>
                                <textarea id="editLabsSummary" placeholder="Laboratory results..."></textarea>
                            </div>
                        </div>
                        
                        <div style="text-align: right; margin-top: 30px;">
                            <button type="button" id="cancelEditPatient" class="btn btn-secondary">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update Patient</button>
                        </div>
                        
                        <div id="editPatientError" class="error-message"></div>
                        <div id="editPatientSuccess" class="success-message"></div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Add Operative Note View -->
            <div id="operativeNoteView" class="hidden">
                <div class="form-container">
                    <h2>🔪 Add Operative Note</h2>
                    
                    <!-- Surgery Templates -->
                    <div style="margin-bottom: 25px; padding: 15px; background: #f0f8ff; border-radius: 8px; border-left: 4px solid #2196F3;">
                        <h3 style="margin-bottom: 15px; color: #333;">📋 Surgery Templates (Click to Auto-Fill)</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <button type="button" class="btn btn-secondary template-btn" data-template="urs_laser">🔹 URS + Laser</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="flexible_urs">🔹 Flexible URS</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="turp">🔹 TURP</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="orchiopexy">🔹 Orchiopexy</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="inguinal_hernia">🔹 Inguinal Hernia</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="pediatric_hernia">🔹 Pediatric Hernia</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="hydrocelectomy">🔹 Hydrocelectomy</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="varicocelectomy">🔹 Varicocelectomy</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="urethrotomy">🔹 Urethrotomy</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="circumcision">🔹 Circumcision</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="pcnl">🔹 PCNL</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="turbt">🔹 TURBT</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="radical_nephrectomy">🔹 Radical Nephrectomy</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="partial_nephrectomy">🔹 Partial Nephrectomy</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="radical_prostatectomy">🔹 Radical Prostatectomy</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="ureteric_reimplant">🔹 Ureteric Reimplant</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="pyeloplasty">🔹 Pyeloplasty</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="cystolitholapaxy">🔹 Cystolitholapaxy</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="radical_orchiectomy">🔹 Radical Orchiectomy</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="simple_orchiectomy">🔹 Simple Orchiectomy</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="scrotal_exploration">🔹 Scrotal Exploration</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="suprapubic_cystostomy">🔹 Suprapubic Cystostomy</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="penile_prosthesis">🔹 Penile Prosthesis</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="bladder_neck_incision">🔹 Bladder Neck Incision</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="urethroplasty">🔹 Urethroplasty</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="meatotomy">🔹 Meatotomy</button>
                            <button type="button" class="btn btn-secondary template-btn" data-template="hypospadias">🔹 Hypospadias Repair</button>
                            <button type="button" class="btn template-btn" data-template="other" style="background: #ff9800; color: white;">✏️ Other Surgery</button>
                        </div>
                    </div>
                    
                    <form id="operativeNoteForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="surgeryType">Surgery Type *</label>
                                <input type="text" id="surgeryType" required>
                            </div>
                            <div class="form-group">
                                <label for="surgeryDate">Surgery Date *</label>
                                <input type="date" id="surgeryDate" required>
                            </div>
                            <div class="form-group">
                                <label for="surgeryTime">Surgery Time</label>
                                <input type="time" id="surgeryTime">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="surgeon">Surgeon *</label>
                                <input type="text" id="surgeon" required>
                            </div>
                            <div class="form-group">
                                <label for="assistants">Assistant(s)</label>
                                <input type="text" id="assistants">
                            </div>
                            <div class="form-group">
                                <label for="anesthesiaType">Anesthesia Type</label>
                                <select id="anesthesiaType">
                                    <option value="">Select Type</option>
                                    <option value="General anesthesia">General</option>
                                    <option value="Spinal anesthesia">Spinal</option>
                                    <option value="Local anesthesia">Local</option>
                                    <option value="Local + sedation">Local + Sedation</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="position">Position</label>
                            <select id="position">
                                <option value="">Select Position</option>
                                <option value="Lithotomy position">Lithotomy</option>
                                <option value="Supine position">Supine</option>
                                <option value="Prone position">Prone</option>
                                <option value="Lateral decubitus position">Lateral Decubitus</option>
                                <option value="Flank position">Flank</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="findings">Findings</label>
                            <textarea id="findings" placeholder="Operative findings and observations..." style="height: 120px;"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="operativeSteps">Operative Steps</label>
                            <textarea id="operativeSteps" placeholder="Detailed operative procedure steps..." style="height: 200px;"></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="complications">Complications</label>
                                <textarea id="complications" placeholder="Any complications encountered..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="bloodLoss">Estimated Blood Loss</label>
                                <input type="text" id="bloodLoss" placeholder="e.g., <50 mL, 100-200 mL">
                            </div>
                        </div>
                        
                        <div style="text-align: right; margin-top: 30px;">
                            <button type="button" id="cancelOperativeNote" class="btn btn-secondary">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Operative Note</button>
                        </div>
                        
                        <div id="operativeNoteError" class="error-message"></div>
                        <div id="operativeNoteSuccess" class="success-message"></div>
                    </form>
                </div>
            </div>
            
            <!-- View Operative Notes -->
            <div id="viewOperativeNotesView" class="hidden">
                <div class="form-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h2>🔪 Operative Notes</h2>
                        <button id="backFromOperativeNotes" class="btn btn-primary">← Back to Patient</button>
                    </div>
                    
                    <div id="operativeNotesList">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading operative notes...</p>
                        </div>
                    </div>
                </div>
            </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCaKJgggVlJYLl6j6klgKUuEc3NmGFQZv4",
            authDomain: "urology-app-6f2d2.firebaseapp.com",
            projectId: "urology-app-6f2d2",
            storageBucket: "urology-app-6f2d2.firebasestorage.app",
            messagingSenderId: "996503565094",
            appId: "1:996503565094:web:7aed31cf47abd380ab07e7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Global variables
        let currentUser = null;
        let userRole = null;
        let allPatients = [];
        
        // DOM elements
        const loadingScreen = document.getElementById('loadingScreen');
        const loginScreen = document.getElementById('loginScreen');
        const mainApp = document.getElementById('mainApp');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');
        const userEmail = document.getElementById('userEmail');
        const userRoleSpan = document.getElementById('userRole');
        
        // Navigation elements
        const showPatientsBtn = document.getElementById('showPatientsBtn');
        const showAddPatientBtn = document.getElementById('showAddPatientBtn');
        const patientsView = document.getElementById('patientsView');
        const addPatientView = document.getElementById('addPatientView');
        
        // Patient management elements
        const patientsList = document.getElementById('patientsList');
        const patientCount = document.getElementById('patientCount');
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const addPatientForm = document.getElementById('addPatientForm');
        const cancelAddPatient = document.getElementById('cancelAddPatient');
        const addPatientError = document.getElementById('addPatientError');
        const addPatientSuccess = document.getElementById('addPatientSuccess');
        
        // Show/hide screens
        function showScreen(screenName) {
            loadingScreen.classList.add('hidden');
            loginScreen.classList.add('hidden');
            mainApp.classList.add('hidden');
            
            if (screenName === 'loading') {
                loadingScreen.classList.remove('hidden');
            } else if (screenName === 'login') {
                loginScreen.classList.remove('hidden');
            } else if (screenName === 'main') {
                mainApp.classList.remove('hidden');
            }
        }
        
        // Show/hide views within main app
        function showView(viewName) {
            patientsView.classList.add('hidden');
            addPatientView.classList.add('hidden');
            
            if (viewName === 'patients') {
                patientsView.classList.remove('hidden');
                showPatientsBtn.classList.add('btn-primary');
                showAddPatientBtn.classList.remove('btn-primary');
            } else if (viewName === 'addPatient') {
                addPatientView.classList.remove('hidden');
                showAddPatientBtn.classList.add('btn-primary');
                showPatientsBtn.classList.remove('btn-primary');
            }
        }
        
        // Show error/success messages
        function showMessage(elementId, message, isSuccess = false) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
            
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }
        
        // Authentication state listener
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        userRole = userData.role;
                        userEmail.textContent = userData.email;
                        userRoleSpan.textContent = userData.role.toUpperCase();
                        
                        showScreen('main');
                        showView('patients');
                        loadPatients();
                        
                        // Set today's date as default
                        document.getElementById('admissionDate').valueAsDate = new Date();
                    } else {
                        showMessage('loginError', 'User role not found. Please contact administrator.');
                        auth.signOut();
                    }
                } catch (error) {
                    console.error('Error getting user data:', error);
                    showMessage('loginError', 'Error loading user data.');
                    auth.signOut();
                }
            } else {
                currentUser = null;
                userRole = null;
                showScreen('login');
            }
        });
        
        // Login form handler
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                console.error('Login error:', error);
                showMessage('loginError', 'Invalid email or password.');
            }
        });
        
        // Logout handler
        logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });
        
        // Navigation handlers
        showPatientsBtn.addEventListener('click', () => {
            showView('patients');
            loadPatients();
        });
        
        showAddPatientBtn.addEventListener('click', () => {
            showView('addPatient');
            addPatientForm.reset();
            document.getElementById('admissionDate').valueAsDate = new Date();
        });
        
        cancelAddPatient.addEventListener('click', () => {
            showView('patients');
        });
        
        // Load patients from Firestore
        async function loadPatients() {
            try {
                patientsList.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading patients...</p></div>';
                
                const snapshot = await db.collection('patients').orderBy('createdAt', 'desc').get();
                allPatients = [];
                
                snapshot.forEach(doc => {
                    allPatients.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                displayPatients(allPatients);
                
            } catch (error) {
                console.error('Error loading patients:', error);
                patientsList.innerHTML = '<p style="text-align: center; color: #f44336;">Error loading patients. Please try again.</p>';
            }
        }
        
        // Display patients list
        function displayPatients(patients) {
            patientCount.textContent = patients.length;
            
            if (patients.length === 0) {
                patientsList.innerHTML = '<p style="text-align: center; color: #666;">No patients found. Click "Add New Patient" to get started.</p>';
                return;
            }
            
            patientsList.innerHTML = patients.map(patient => `
                <div class="patient-card">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <h3>${patient.name || 'Unnamed Patient'}</h3>
                        <span class="status-badge status-${patient.status || 'pre-op'}">${patient.status || 'pre-op'}</span>
                    </div>
                    <div class="patient-info">
                        <span><strong>MRN:</strong> ${patient.mrn || 'N/A'}</span>
                        <span><strong>Age:</strong> ${patient.age || 'N/A'}</span>
                        <span><strong>Gender:</strong> ${patient.gender || 'N/A'}</span>
                        <span><strong>Room:</strong> ${patient.roomNumber || 'N/A'}</span>
                        <span><strong>Admission:</strong> ${patient.admissionDate || 'N/A'}</span>
                        <span><strong>Phone:</strong> ${patient.phone || 'N/A'}</span>
                    </div>
                    <div class="patient-info">
                        <span><strong>Complaint:</strong> ${(patient.presentingComplaint || 'N/A').substring(0, 100)}${(patient.presentingComplaint || '').length > 100 ? '...' : ''}</span>
                    </div>
                    <div class="patient-actions">
                        <button class="btn btn-primary btn-sm" onclick="viewPatient('${patient.id}')">📋 View Details</button>
                        <button class="btn btn-secondary btn-sm" onclick="editPatient('${patient.id}')">✏️ Edit</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Search and filter functionality
        searchInput.addEventListener('input', filterPatients);
        statusFilter.addEventListener('change', filterPatients);
        
        function filterPatients() {
            const searchTerm = searchInput.value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filteredPatients = allPatients.filter(patient => {
                const matchesSearch = !searchTerm || 
                    (patient.name || '').toLowerCase().includes(searchTerm) ||
                    (patient.mrn || '').toLowerCase().includes(searchTerm) ||
                    (patient.roomNumber || '').toLowerCase().includes(searchTerm);
                
                const matchesStatus = !statusFilter || patient.status === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            displayPatients(filteredPatients);
        }
        
        // Add patient form handler
        addPatientForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const patientData = {
                    name: document.getElementById('patientName').value,
                    mrn: document.getElementById('patientMRN').value,
                    age: parseInt(document.getElementById('patientAge').value) || null,
                    gender: document.getElementById('patientGender').value,
                    phone: document.getElementById('patientPhone').value,
                    roomNumber: document.getElementById('roomNumber').value,
                    admissionDate: document.getElementById('admissionDate').value,
                    presentingComplaint: document.getElementById('presentingComplaint').value,
                    pmh: document.getElementById('pmh').value,
                    allergies: document.getElementById('allergies').value,
                    medications: document.getElementById('medications').value,
                    physicalExam: document.getElementById('physicalExam').value,
                    imagingSummary: document.getElementById('imagingSummary').value,
                    labsSummary: document.getElementById('labsSummary').value,
                    status: 'pre-op',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid,
                    createdByName: userEmail.textContent
                };
                
                await db.collection('patients').add(patientData);
                
                showMessage('addPatientSuccess', 'Patient added successfully!', true);
                addPatientForm.reset();
                document.getElementById('admissionDate').valueAsDate = new Date();
                
                setTimeout(() => {
                    showView('patients');
                    loadPatients();
                }, 2000);
                
            } catch (error) {
                console.error('Error adding patient:', error);
                showMessage('addPatientError', 'Error adding patient. Please try again.');
            }
        });
        
        // Placeholder functions for future features
       // Global variable for current patient
        let currentPatientId = null;
        let currentPatientData = null;
        
        // DOM elements for new views
        const patientDetailView = document.getElementById('patientDetailView');
        const editPatientView = document.getElementById('editPatientView');
        const patientDetailName = document.getElementById('patientDetailName');
        const patientDetailContent = document.getElementById('patientDetailContent');
        const editPatientBtn = document.getElementById('editPatientBtn');
        const backToPatientsBtn = document.getElementById('backToPatientsBtn');
        const editPatientForm = document.getElementById('editPatientForm');
        const cancelEditPatient = document.getElementById('cancelEditPatient');
        const deletePatientBtn = document.getElementById('deletePatientBtn');
        
        // Update showView function to handle new views
        function showView(viewName) {
            patientsView.classList.add('hidden');
            addPatientView.classList.add('hidden');
            patientDetailView.classList.add('hidden');
            editPatientView.classList.add('hidden');
            
            // Reset button states
            showPatientsBtn.classList.remove('btn-primary');
            showAddPatientBtn.classList.remove('btn-primary');
            
            if (viewName === 'patients') {
                patientsView.classList.remove('hidden');
                showPatientsBtn.classList.add('btn-primary');
            } else if (viewName === 'addPatient') {
                addPatientView.classList.remove('hidden');
                showAddPatientBtn.classList.add('btn-primary');
            } else if (viewName === 'patientDetail') {
                patientDetailView.classList.remove('hidden');
            } else if (viewName === 'editPatient') {
                editPatientView.classList.remove('hidden');
            }
        }
        
        // View patient details
        async function viewPatient(patientId) {
            try {
                currentPatientId = patientId;
                showView('patientDetail');
                
                // Load patient data
                const doc = await db.collection('patients').doc(patientId).get();
                if (doc.exists) {
                    currentPatientData = { id: doc.id, ...doc.data() };
                    displayPatientDetail(currentPatientData);
                } else {
                    alert('Patient not found');
                    showView('patients');
                }
            } catch (error) {
                console.error('Error loading patient:', error);
                alert('Error loading patient details');
                showView('patients');
            }
        }
        
        // Display patient detail
        function displayPatientDetail(patient) {
            patientDetailName.textContent = patient.name || 'Unnamed Patient';
            
            const formatDate = (dateStr) => {
                if (!dateStr) return 'N/A';
                try {
                    return new Date(dateStr).toLocaleDateString();
                } catch {
                    return dateStr;
                }
            };
            
            patientDetailContent.innerHTML = `
                <div class="patient-header">
                    <div>
                        <h2>${patient.name || 'Unnamed Patient'}</h2>
                        <div class="patient-meta">
                            <span>MRN: ${patient.mrn || 'N/A'}</span>
                            <span>Age: ${patient.age || 'N/A'}</span>
                            <span>Gender: ${patient.gender || 'N/A'}</span>
                            <span class="status-badge status-${patient.status || 'pre-op'}">${patient.status || 'pre-op'}</span>
                        </div>
                    </div>
                </div>
                
                <div class="patient-detail-grid">
                    <div class="detail-section">
                        <h3>📋 Basic Information</h3>
                        <p><strong>Phone:</strong> ${patient.phone || 'N/A'}</p>
                        <p><strong>Room:</strong> ${patient.roomNumber || 'N/A'}</p>
                        <p><strong>Admission:</strong> ${formatDate(patient.admissionDate)}</p>
                        <p><strong>Created by:</strong> ${patient.createdByName || 'Unknown'}</p>
                    </div>
                    
                    <div class="detail-section">
                        <h3>🩺 Medical History</h3>
                        <p><strong>Allergies:</strong> ${patient.allergies || 'None reported'}</p>
                        <p><strong>Medications:</strong> ${patient.medications || 'None listed'}</p>
                        <p><strong>PMH:</strong> ${patient.pmh || 'Not documented'}</p>
                    </div>
                    
                    <div class="detail-section">
                        <h3>🔍 Presenting Complaint</h3>
                        <p>${patient.presentingComplaint || 'Not documented'}</p>
                    </div>
                    
                    <div class="detail-section">
                        <h3>👥 Physical Examination</h3>
                        <p>${patient.physicalExam || 'Not documented'}</p>
                    </div>
                    
                    <div class="detail-section">
                        <h3>🩻 Imaging Summary</h3>
                        <p>${patient.imagingSummary || 'No imaging documented'}</p>
                    </div>
                    
                    <div class="detail-section">
                        <h3>🧪 Laboratory Results</h3>
                        <p>${patient.labsSummary || 'No labs documented'}</p>
                    </div>
                </div>
            `;
        }
        
        // Edit patient
        function editPatient(patientId) {
            if (patientId) {
                currentPatientId = patientId;
                // Load patient data first if not already loaded
                if (!currentPatientData || currentPatientData.id !== patientId) {
                    viewPatient(patientId).then(() => {
                        populateEditForm();
                        showView('editPatient');
                    });
                } else {
                    populateEditForm();
                    showView('editPatient');
                }
            } else if (currentPatientData) {
                populateEditForm();
                showView('editPatient');
            }
        }
        
        // Populate edit form with current patient data
        function populateEditForm() {
            if (!currentPatientData) return;
            
            document.getElementById('editPatientName').value = currentPatientData.name || '';
            document.getElementById('editPatientMRN').value = currentPatientData.mrn || '';
            document.getElementById('editPatientAge').value = currentPatientData.age || '';
            document.getElementById('editPatientGender').value = currentPatientData.gender || '';
            document.getElementById('editPatientPhone').value = currentPatientData.phone || '';
            document.getElementById('editRoomNumber').value = currentPatientData.roomNumber || '';
            document.getElementById('editAdmissionDate').value = currentPatientData.admissionDate || '';
            document.getElementById('editPatientStatus').value = currentPatientData.status || 'pre-op';
            document.getElementById('editPresentingComplaint').value = currentPatientData.presentingComplaint || '';
            document.getElementById('editPmh').value = currentPatientData.pmh || '';
            document.getElementById('editAllergies').value = currentPatientData.allergies || '';
            document.getElementById('editMedications').value = currentPatientData.medications || '';
            document.getElementById('editPhysicalExam').value = currentPatientData.physicalExam || '';
            document.getElementById('editImagingSummary').value = currentPatientData.imagingSummary || '';
            document.getElementById('editLabsSummary').value = currentPatientData.labsSummary || '';
        }
        
        // Delete patient with confirmation
        function confirmDeletePatient() {
            if (!currentPatientData) return;
            
            const confirmDialog = document.createElement('div');
            confirmDialog.className = 'confirmation-dialog';
            confirmDialog.innerHTML = `
                <div class="confirmation-content">
                    <h3>⚠️ Delete Patient</h3>
                    <p>Are you sure you want to delete <strong>${currentPatientData.name}</strong>?</p>
                    <p style="color: #f44336; font-size: 14px;">This action cannot be undone!</p>
                    <div>
                        <button class="btn btn-secondary" onclick="closeConfirmDialog()">Cancel</button>
                        <button class="btn btn-danger" onclick="deletePatientConfirmed()" style="margin-left: 10px;">Delete</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmDialog);
        }
        
        // Close confirmation dialog
        function closeConfirmDialog() {
            const dialog = document.querySelector('.confirmation-dialog');
            if (dialog) {
                dialog.remove();
            }
        }
        
        // Actually delete the patient
        async function deletePatientConfirmed() {
            try {
                await db.collection('patients').doc(currentPatientId).delete();
                closeConfirmDialog();
                showView('patients');
                loadPatients();
                alert('Patient deleted successfully');
            } catch (error) {
                console.error('Error deleting patient:', error);
                alert('Error deleting patient');
            }
        }
        
        // Event listeners for new buttons
        editPatientBtn.addEventListener('click', () => editPatient());
        backToPatientsBtn.addEventListener('click', () => showView('patients'));
        cancelEditPatient.addEventListener('click', () => showView('patientDetail'));
        deletePatientBtn.addEventListener('click', confirmDeletePatient);
        
        // Edit patient form handler
        editPatientForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const updatedData = {
                    name: document.getElementById('editPatientName').value,
                    mrn: document.getElementById('editPatientMRN').value,
                    age: parseInt(document.getElementById('editPatientAge').value) || null,
                    gender: document.getElementById('editPatientGender').value,
                    phone: document.getElementById('editPatientPhone').value,
                    roomNumber: document.getElementById('editRoomNumber').value,
                    admissionDate: document.getElementById('editAdmissionDate').value,
                    status: document.getElementById('editPatientStatus').value,
                    presentingComplaint: document.getElementById('editPresentingComplaint').value,
                    pmh: document.getElementById('editPmh').value,
                    allergies: document.getElementById('editAllergies').value,
                    medications: document.getElementById('editMedications').value,
                    physicalExam: document.getElementById('editPhysicalExam').value,
                    imagingSummary: document.getElementById('editImagingSummary').value,
                    labsSummary: document.getElementById('editLabsSummary').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.uid,
                    updatedByName: userEmail.textContent
                };
                
                await db.collection('patients').doc(currentPatientId).update(updatedData);
                
                showMessage('editPatientSuccess', 'Patient updated successfully!', true);
                
                // Update current patient data
                currentPatientData = { ...currentPatientData, ...updatedData };
                
                setTimeout(() => {
                    showView('patientDetail');
                    displayPatientDetail(currentPatientData);
                    loadPatients(); // Refresh the list
                }, 2000);
                
            } catch (error) {
                console.error('Error updating patient:', error);
                showMessage('editPatientError', 'Error updating patient. Please try again.');
            }
        });
        
        // Placeholder functions for future features (Part 4)
        document.getElementById('addOperativeNoteBtn').addEventListener('click', () => {
            alert('Add Operative Note feature will be added in Part 4!');
        });
        
        document.getElementById('addDailyLogBtn').addEventListener('click', () => {
            alert('Add Daily Log feature will be added in Part 5!');
        });
        
        document.getElementById('createDischargeBtn').addEventListener('click', () => {
            alert('Discharge Summary feature will be added in Part 6!');
        });
        
        // Surgery Templates Database
        const surgeryTemplates = {
            urs_laser: {
                name: "Ureteric Stone Extraction with Thulium Laser Lithotripsy",
                surgeryType: "Right/Left ureteroscopic stone extraction with Thulium laser lithotripsy and DJ stent placement",
                anesthesiaType: "General anesthesia",
                position: "Lithotomy position",
                findings: "A single/multiple stone(s) were identified in the mid/distal ureter. The ureter was mildly edematous. No evidence of perforation or extravasation was noted.",
                operativeSteps: `1. After induction of general anesthesia, the patient was placed in lithotomy position and prepped and draped in sterile fashion.
2. A safety guidewire was introduced into the ureter under cystoscopic guidance.
3. A semi-rigid ureteroscope was advanced to visualize the ureteric stone.
4. Thulium laser lithotripsy was performed to dust and fragment the stone.
5. Fragments were retrieved with a basket as needed.
6. A retrograde pyelogram was performed to assess the upper tract and confirm integrity.
7. A 5/6 Fr DJ stent was inserted over the guidewire with the distal curl in the bladder and proximal coil in the renal pelvis.
8. Hemostasis was confirmed, and instruments were withdrawn.`,
                complications: "None encountered intraoperatively",
                bloodLoss: "<50 mL"
            },
            flexible_urs: {
                name: "Flexible Ureteroscopy (URS) for Renal Stones",
                surgeryType: "Unilateral/Bilateral flexible ureteroscopy with laser lithotripsy and DJ stent placement",
                anesthesiaType: "General anesthesia",
                position: "Lithotomy position",
                findings: "Multiple/single stone(s) noted within the renal pelvis and calyces, most commonly lower pole. Mucosa was intact with mild edema. No extravasation or ureteral injury observed.",
                operativeSteps: `1. Under general anesthesia, the patient was placed in the lithotomy position and prepped and draped in sterile fashion.
2. A safety guidewire was inserted into the ureter under cystoscopic guidance.
3. A ureteral access sheath was introduced where feasible.
4. A flexible ureteroscope was advanced to the renal pelvis, and all calyces were systematically inspected.
5. Stones were visualized and fragmented using Thulium laser (dusting and/or fragmentation technique).
6. Fragments were actively retrieved using a nitinol basket where appropriate.
7. Complete inspection of all calyces was performed to exclude residual fragments.
8. A 5/6 Fr DJ stent was inserted in the treated side(s) under fluoroscopic or endoscopic guidance.
9. Hemostasis was verified, and all instruments were removed.`,
                complications: "None encountered intraoperatively",
                bloodLoss: "<50 mL"
            },
            turp: {
                name: "Transurethral Resection of the Prostate (TURP)",
                surgeryType: "Transurethral resection of the prostate (TURP)",
                anesthesiaType: "Spinal anesthesia",
                position: "Lithotomy position",
                findings: "Enlarged prostate gland with prominent lateral and median lobes protruding into the bladder. Mild trabeculation of bladder noted. No bladder stones or tumors observed. Ureteric orifices identified bilaterally and preserved.",
                operativeSteps: `1. Under spinal anesthesia, the patient was placed in the lithotomy position, prepped, and draped in sterile fashion.
2. Initial cystoscopy was performed to assess the bladder and visualize the prostatic enlargement and ureteric orifices.
3. A monopolar/bipolar resectoscope was introduced.
4. Resection began at the median lobe, followed by the lateral lobes, proceeding in a systematic fashion down to the surgical capsule.
5. Bladder neck was resected and smoothed.
6. Complete hemostasis was achieved using coagulation current.
7. Prostatic chips were evacuated using an Ellik evacuator.
8. A 22/24 Fr three-way Foley catheter was inserted and continuous bladder irrigation was started.`,
                complications: "None encountered intraoperatively",
                bloodLoss: "Approximately 200 mL"
            },
            orchiopexy: {
                name: "Orchiopexy for Undescended Testis",
                surgeryType: "Right/Left inguinal exploration and orchiopexy",
                anesthesiaType: "General anesthesia",
                position: "Supine position",
                findings: "Testis found in the inguinal canal/at the internal ring. Spermatic cord of adequate length with no significant tension after mobilization. Hernial sac present/absent.",
                operativeSteps: `1. Under general anesthesia, the patient was placed in the supine position and prepped and draped in sterile fashion.
2. A standard inguinal incision was made over the inguinal canal.
3. The external oblique aponeurosis was opened, and the cord structures were isolated.
4. The undescended testis was identified and mobilized with high dissection of the cord structures.
5. A patent processus vaginalis was identified and ligated at the level of the internal ring (if present).
6. The testis was brought down to the scrotum through a subdartos pouch via a separate scrotal incision.
7. The testis was fixed in position using absorbable sutures.
8. Hemostasis was ensured, and the inguinal and scrotal wounds were closed in layers.`,
                complications: "None encountered intraoperatively",
                bloodLoss: "Minimal (<20 mL)"
            },
            circumcision: {
                name: "Surgical Circumcision",
                surgeryType: "Circumcision using sleeve technique",
                anesthesiaType: "Local anesthesia with/without sedation",
                position: "Supine position",
                findings: "Phimosis/paraphimosis/redundant foreskin. No signs of infection or inflammation. Glans penis appeared healthy and intact.",
                operativeSteps: `1. The patient was placed in the supine position and prepped and draped in sterile fashion.
2. Local anesthetic was infiltrated at the base of the penis (penile block) with or without dorsal nerve block.
3. The preputial adhesions were released and the foreskin fully retracted.
4. Markings were made for the sleeve excision at the junction of inner and outer prepuce.
5. The foreskin was incised circumferentially and excised carefully, preserving the glans and frenulum.
6. Hemostasis was achieved with electrocautery or ligatures.
7. The edges of the skin were approximated with interrupted or running absorbable sutures (e.g., 4-0 Vicryl Rapide).
8. Sterile dressing was applied.`,
                complications: "None encountered intraoperatively",
                bloodLoss: "Minimal (<10 mL)"
            },
            pcnl: {
                name: "Percutaneous Nephrolithotomy (PCNL)",
                surgeryType: "Percutaneous nephrolithotomy – Right/Left kidney",
                anesthesiaType: "General anesthesia",
                position: "Initial lithotomy, then prone position",
                findings: "Large renal calculus occupying the renal pelvis with/without extension into calyces. Moderate hydronephrosis. No collecting system perforation or bleeding encountered during the procedure.",
                operativeSteps: `1. Under general anesthesia, the patient was initially positioned in lithotomy position and prepped and draped in sterile fashion.
2. A cystoscopy was performed and a 5–6 Fr open-ended ureteric catheter was advanced into the renal pelvis under fluoroscopic guidance.
3. The catheter was secured and connected to contrast for subsequent pelvicalyceal system opacification.
4. The patient was then repositioned into prone position and re-prepped and draped.
5. Percutaneous access was obtained into a posterior lower/middle calyx under fluoroscopic (or ultrasound) guidance.
6. The tract was dilated using serial fascial dilators or a balloon dilator, and a 30 Fr Amplatz sheath was placed.
7. A rigid nephroscope was introduced through the sheath.
8. Stones were visualized and fragmented using ultrasonic/pneumatic lithotripter or laser.
9. Fragments were extracted using forceps or suction, and a flexible nephroscope was used to inspect all calyces for residual stones.
10. A nephrostomy tube was inserted. DJ stent was placed if indicated.
11. Hemostasis was confirmed and dressing applied.`,
                complications: "None encountered intraoperatively",
                bloodLoss: "Approximately 100–300 mL"
            },
            other: {
                name: "Other Surgery (Manual Entry)",
                surgeryType: "",
                anesthesiaType: "",
                position: "",
                findings: "",
                operativeSteps: "",
                complications: "",
                bloodLoss: ""
            }
        };
        
        // Add more templates for the remaining surgeries
        surgeryTemplates.inguinal_hernia = {
            name: "Inguinal Hernia Repair (Open Hernioplasty)",
            surgeryType: "Right/Left inguinal hernia repair with mesh (Lichtenstein hernioplasty)",
            anesthesiaType: "Spinal anesthesia",
            position: "Supine position",
            findings: "Indirect/direct inguinal hernia sac identified. No bowel compromise. Hernia contents reducible. Spermatic cord and surrounding structures preserved.",
            operativeSteps: `1. Under spinal anesthesia, the patient was placed in the supine position and prepped and draped in sterile fashion.
2. An oblique inguinal incision was made, and the external oblique aponeurosis was incised.
3. The hernia sac was identified and dissected from the cord structures.
4. The sac was opened, contents inspected and reduced into the peritoneal cavity.
5. The sac was transfixed and excised.
6. A polypropylene mesh was fashioned and placed over the posterior wall of the inguinal canal, covering the deep ring.
7. The mesh was fixed to the pubic tubercle medially, to the inguinal ligament inferiorly, and to the conjoint tendon superiorly.
8. The external oblique aponeurosis was closed over the cord, followed by skin closure.`,
            complications: "None encountered intraoperatively",
            bloodLoss: "<50 mL"
        };
        
        surgeryTemplates.pediatric_hernia = {
            name: "Pediatric Inguinal Hernia Repair (Herniotomy)",
            surgeryType: "Right/Left inguinal herniotomy",
            anesthesiaType: "General anesthesia",
            position: "Supine position",
            findings: "Indirect hernia sac extending through the deep inguinal ring. Hernia contents reducible. No ischemic changes observed. Testis and cord structures were normal.",
            operativeSteps: `1. Under general anesthesia, the patient was positioned supine and prepped and draped in a sterile fashion.
2. A transverse skin crease incision was made over the inguinal region.
3. The external oblique aponeurosis was incised, and the inguinal canal was opened.
4. The hernia sac was identified lateral to the cord structures and carefully dissected free.
5. The sac was opened, and its contents were reduced into the peritoneal cavity.
6. The sac was transfixed and ligated high at the level of the internal ring using absorbable suture.
7. Excess sac distal to the ligature was excised.
8. The inguinal canal was closed, and the wound was closed in layers with absorbable sutures.`,
            complications: "None encountered intraoperatively",
            bloodLoss: "Minimal (<10 mL)"
        };
        
        // DOM elements for operative notes
        const operativeNoteView = document.getElementById('operativeNoteView');
        const viewOperativeNotesView = document.getElementById('viewOperativeNotesView');
        const operativeNoteForm = document.getElementById('operativeNoteForm');
        const cancelOperativeNote = document.getElementById('cancelOperativeNote');
        const operativeNotesList = document.getElementById('operativeNotesList');
        const backFromOperativeNotes = document.getElementById('backFromOperativeNotes');
        
        // Update showView function to handle operative note views
        function showView(viewName) {
            patientsView.classList.add('hidden');
            addPatientView.classList.add('hidden');
            patientDetailView.classList.add('hidden');
            editPatientView.classList.add('hidden');
            operativeNoteView.classList.add('hidden');
            viewOperativeNotesView.classList.add('hidden');
            
            // Reset button states
            showPatientsBtn.classList.remove('btn-primary');
            showAddPatientBtn.classList.remove('btn-primary');
            
            if (viewName === 'patients') {
                patientsView.classList.remove('hidden');
                showPatientsBtn.classList.add('btn-primary');
            } else if (viewName === 'addPatient') {
                addPatientView.classList.remove('hidden');
                showAddPatientBtn.classList.add('btn-primary');
            } else if (viewName === 'patientDetail') {
                patientDetailView.classList.remove('hidden');
            } else if (viewName === 'editPatient') {
                editPatientView.classList.remove('hidden');
            } else if (viewName === 'operativeNote') {
                operativeNoteView.classList.remove('hidden');
            } else if (viewName === 'viewOperativeNotes') {
                viewOperativeNotesView.classList.remove('hidden');
            }
        }
        
        // Template button handlers
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('template-btn')) {
                const templateKey = e.target.getAttribute('data-template');
                const template = surgeryTemplates[templateKey];
                
                if (template) {
                    // Remove active class from all template buttons
                    document.querySelectorAll('.template-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Add active class to clicked button
                    e.target.classList.add('active');
                    
                    // Fill form with template data
                    document.getElementById('surgeryType').value = template.surgeryType;
                    document.getElementById('anesthesiaType').value = template.anesthesiaType;
                    document.getElementById('position').value = template.position;
                    document.getElementById('findings').value = template.findings;
                    document.getElementById('operativeSteps').value = template.operativeSteps;
                    document.getElementById('complications').value = template.complications;
                    document.getElementById('bloodLoss').value = template.bloodLoss;
                    
                    // Set today's date and current user as surgeon
                    document.getElementById('surgeryDate').valueAsDate = new Date();
                    document.getElementById('surgeon').value = userEmail.textContent.split('@')[0].replace('.', ' ');
                }
            }
        });
        
        // Operative note form handler
        operativeNoteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const operativeNoteData = {
                    surgeryType: document.getElementById('surgeryType').value,
                    surgeryDate: document.getElementById('surgeryDate').value,
                    surgeryTime: document.getElementById('surgeryTime').value,
                    surgeon: document.getElementById('surgeon').value,
                    assistants: document.getElementById('assistants').value,
                    anesthesiaType: document.getElementById('anesthesiaType').value,
                    position: document.getElementById('position').value,
                    findings: document.getElementById('findings').value,
                    operativeSteps: document.getElementById('operativeSteps').value,
                    complications: document.getElementById('complications').value,
                    bloodLoss: document.getElementById('bloodLoss').value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid,
                    createdByName: userEmail.textContent,
                    patientId: currentPatientId
                };
                
                await db.collection('patients').doc(currentPatientId).collection('operativeNotes').add(operativeNoteData);
                
                showMessage('operativeNoteSuccess', 'Operative note saved successfully!', true);
                operativeNoteForm.reset();
                
                setTimeout(() => {
                    showView('patientDetail');
                    displayPatientDetail(currentPatientData);
                }, 2000);
                
            } catch (error) {
                console.error('Error saving operative note:', error);
                showMessage('operativeNoteError', 'Error saving operative note. Please try again.');
            }
        });
        
        // Navigation handlers
        cancelOperativeNote.addEventListener('click', () => {
            showView('patientDetail');
        });
        
        backFromOperativeNotes.addEventListener('click', () => {
            showView('patientDetail');
        });
        
        // Update the "Add Operative Note" button handler
        document.getElementById('addOperativeNoteBtn').addEventListener('click', () => {
            showView('operativeNote');
            operativeNoteForm.reset();
            document.getElementById('surgeryDate').valueAsDate = new Date();
            document.getElementById('surgeon').value = userEmail.textContent.split('@')[0].replace('.', ' ');
            
            // Remove active state from all template buttons
            document.querySelectorAll('.template-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        });
        // Initialize app
        showScreen('loading');
    </script>
</body>
</html>
