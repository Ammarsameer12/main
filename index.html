<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urology Patient Follow-Up</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            background: #45a049;
        }
        
        .btn-danger {
            background: #f44336;
        }
        
        .btn-danger:hover {
            background: #da190b;
        }
        
        .btn-primary {
            background: #2196F3;
        }
        
        .btn-primary:hover {
            background: #1976D2;
        }
        
        .btn-secondary {
            background: #757575;
        }
        
        .btn-secondary:hover {
            background: #616161;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .sidebar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: fit-content;
        }
        
        .main-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .patient-card {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .patient-card:hover {
            background: #e3f2fd;
            border-color: #2196F3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .patient-card.selected {
            background: #e8f5e8;
            border-color: #4CAF50;
        }
        
        .patient-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 5px;
        }
        
        .patient-info {
            color: #666;
            font-size: 0.9rem;
        }
        
        .follow-up-form {
            display: none;
        }
        
        .follow-up-form.active {
            display: block;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .hidden {
            display: none !important;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .template-btn {
            padding: 8px 12px;
            font-size: 13px;
            border-radius: 5px;
            border: 2px solid #ddd;
            background: white;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .template-btn:hover {
            border-color: #2196F3;
            background: #e3f2fd;
            color: #1976D2;
            transform: translateY(-1px);
        }
        
        .template-btn.active {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
        }
        
        .operative-note-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 5px solid #4CAF50;
        }
        
        .operative-note-card h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .operative-note-header {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .operative-note-header span {
            color: #555;
            font-size: 14px;
        }
        
        .operative-note-header strong {
            color: #333;
            display: inline-block;
            min-width: 80px;
        }
        
        .operative-section {
            margin-bottom: 20px;
        }
        
        .operative-section h5 {
            color: #2196F3;
            margin-bottom: 10px;
            font-size: 1.1rem;
            border-bottom: 2px solid #e3f2fd;
            padding-bottom: 5px;
        }
        
        .operative-section p {
            color: #666;
            line-height: 1.8;
            white-space: pre-wrap;
        }
        
        .operative-note-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            font-size: 13px;
            color: #888;
        }
        
        .operative-note-actions {
            display: flex;
            gap: 10px;
        }
        
        .no-operative-notes {
            text-align: center;
            padding: 40px;
            color: #666;
            background: #f9f9f9;
            border-radius: 10px;
            border: 2px dashed #ddd;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .user-info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Urology Practice Login</h2>
        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" placeholder="Enter your email">
        </div>
        <div class="form-group">
            <label for="password">Password:</label>
            <input type="password" id="password" placeholder="Enter your password">
        </div>
        <button onclick="login()" class="btn btn-primary" style="width: 100%;">Login</button>
        <div id="loginError" class="alert alert-error hidden" style="margin-top: 15px;"></div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <div class="container">
            <div class="header">
                <h1>Urology Patient Follow-Up System</h1>
                <div class="user-info">
                    <span id="userEmail"></span>
                    <button onclick="logout()" class="btn btn-danger">Logout</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalPatients">0</div>
                    <div class="stat-label">Total Patients</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingFollowUps">0</div>
                    <div class="stat-label">Pending Follow-ups</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedToday">0</div>
                    <div class="stat-label">Completed Today</div>
                </div>
            </div>

            <div class="dashboard">
                <div class="sidebar">
                    <h3 style="margin-bottom: 20px; color: #333;">Patients</h3>
                    <button onclick="showAddPatientForm()" class="btn btn-primary" style="width: 100%; margin-bottom: 20px;">Add New Patient</button>
                    <div id="patientsList" class="loading">Loading patients...</div>
                </div>

                <div class="main-content">
                    <div id="welcomeMessage">
                        <h3>Welcome to the Urology Follow-up System</h3>
                        <p>Select a patient from the sidebar to begin follow-up documentation, or add a new patient.</p>
                    </div>

                    <!-- Add Patient Form -->
                    <div id="addPatientForm" class="follow-up-form">
                        <h3>Add New Patient</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="patientName">Full Name:</label>
                                <input type="text" id="patientName" placeholder="Enter patient name">
                            </div>
                            <div class="form-group">
                                <label for="patientAge">Age:</label>
                                <input type="number" id="patientAge" placeholder="Enter age">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="patientGender">Gender:</label>
                                <select id="patientGender">
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="patientPhone">Phone:</label>
                                <input type="tel" id="patientPhone" placeholder="Enter phone number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="patientDiagnosis">Primary Diagnosis:</label>
                            <input type="text" id="patientDiagnosis" placeholder="Enter primary diagnosis">
                        </div>
                        <div class="form-group">
                            <label for="patientNotes">Initial Notes:</label>
                            <textarea id="patientNotes" placeholder="Enter any initial notes or medical history"></textarea>
                        </div>
                        <button onclick="addPatient()" class="btn">Add Patient</button>
                        <button onclick="cancelAddPatient()" class="btn btn-secondary">Cancel</button>
                    </div>

                                         <!-- Follow-up Form -->
                     <div id="followUpForm" class="follow-up-form">
                         <h3 id="selectedPatientName">Patient Follow-up</h3>
                         
                         <div class="form-row">
                             <div class="form-group">
                                 <label for="followUpDate">Follow-up Date:</label>
                                 <input type="date" id="followUpDate">
                             </div>
                             <div class="form-group">
                                 <label for="followUpType">Follow-up Type:</label>
                                 <select id="followUpType">
                                     <option value="">Select Type</option>
                                     <option value="Post-operative">Post-operative</option>
                                     <option value="Routine Check-up">Routine Check-up</option>
                                     <option value="Symptom Assessment">Symptom Assessment</option>
                                     <option value="Lab Results Review">Lab Results Review</option>
                                     <option value="Imaging Review">Imaging Review</option>
                                     <option value="Treatment Response">Treatment Response</option>
                                 </select>
                             </div>
                         </div>

                         <div class="form-group">
                             <label for="symptoms">Current Symptoms:</label>
                             <textarea id="symptoms" placeholder="Describe current symptoms or complaints"></textarea>
                         </div>

                         <div class="form-row">
                             <div class="form-group">
                                 <label for="painLevel">Pain Level (0-10):</label>
                                 <select id="painLevel">
                                     <option value="">Select Level</option>
                                     <option value="0">0 - No Pain</option>
                                     <option value="1">1 - Minimal</option>
                                     <option value="2">2 - Mild</option>
                                     <option value="3">3 - Mild</option>
                                     <option value="4">4 - Moderate</option>
                                     <option value="5">5 - Moderate</option>
                                     <option value="6">6 - Moderate</option>
                                     <option value="7">7 - Severe</option>
                                     <option value="8">8 - Severe</option>
                                     <option value="9">9 - Very Severe</option>
                                     <option value="10">10 - Worst Possible</option>
                                 </select>
                             </div>
                             <div class="form-group">
                                 <label for="functionalStatus">Functional Status:</label>
                                 <select id="functionalStatus">
                                     <option value="">Select Status</option>
                                     <option value="Normal">Normal Activity</option>
                                     <option value="Slightly Limited">Slightly Limited</option>
                                     <option value="Moderately Limited">Moderately Limited</option>
                                     <option value="Severely Limited">Severely Limited</option>
                                     <option value="Unable">Unable to Function</option>
                                 </select>
                             </div>
                         </div>

                         <div class="form-group">
                             <label for="medications">Current Medications:</label>
                             <textarea id="medications" placeholder="List current medications and dosages"></textarea>
                         </div>

                         <div class="form-group">
                             <label for="examination">Physical Examination Findings:</label>
                             <textarea id="examination" placeholder="Document examination findings"></textarea>
                         </div>

                         <div class="form-group">
                             <label for="assessment">Assessment:</label>
                             <textarea id="assessment" placeholder="Clinical assessment and impression"></textarea>
                         </div>

                         <div class="form-group">
                             <label for="plan">Treatment Plan:</label>
                             <textarea id="plan" placeholder="Treatment plan and next steps"></textarea>
                         </div>

                         <div class="form-row">
                             <div class="form-group">
                                 <label for="nextAppointment">Next Appointment:</label>
                                 <input type="date" id="nextAppointment">
                             </div>
                             <div class="form-group">
                                 <label for="urgency">Urgency Level:</label>
                                 <select id="urgency">
                                     <option value="">Select Urgency</option>
                                     <option value="Routine">Routine</option>
                                     <option value="Urgent">Urgent</option>
                                     <option value="Emergency">Emergency</option>
                                 </select>
                             </div>
                         </div>

                         <button onclick="saveFollowUp()" class="btn">Save Follow-up</button>
                         <button onclick="clearForm()" class="btn btn-secondary">Clear Form</button>
                         <button onclick="showOperativeNotes()" class="btn btn-primary" style="margin-left: 10px;">üî™ View Operative Notes</button>
                         <button onclick="showAddOperativeNote()" class="btn" style="margin-left: 10px;">‚ûï Add Operative Note</button>
                     </div>

                     <!-- Operative Notes View -->
                     <div id="operativeNotesView" class="follow-up-form">
                         <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                             <h3>üî™ Operative Notes</h3>
                             <button onclick="backToPatientView()" class="btn btn-secondary">‚Üê Back to Patient</button>
                         </div>
                         <div id="operativeNotesList">Loading operative notes...</div>
                     </div>

                     <!-- Add Operative Note Form -->
                     <div id="addOperativeNoteView" class="follow-up-form">
                         <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                             <h3 id="operativeNoteTitle">üî™ Add Operative Note</h3>
                             <button onclick="backToPatientView()" class="btn btn-secondary">‚Üê Back to Patient</button>
                         </div>

                         <!-- Surgery Templates -->
                         <div style="margin-bottom: 25px; padding: 15px; background: #f0f8ff; border-radius: 8px; border-left: 4px solid #2196F3;">
                             <h4 style="margin-bottom: 15px; color: #333;">üìã Surgery Templates (Click to Auto-Fill)</h4>
                             <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px;">
                                 <button type="button" class="template-btn" data-template="urs_laser">üîπ URS + Laser</button>
                                 <button type="button" class="template-btn" data-template="flexible_urs">üîπ Flexible URS</button>
                                 <button type="button" class="template-btn" data-template="turp">üîπ TURP</button>
                                 <button type="button" class="template-btn" data-template="orchiopexy">üîπ Orchiopexy</button>
                                 <button type="button" class="template-btn" data-template="circumcision">üîπ Circumcision</button>
                                 <button type="button" class="template-btn" data-template="pcnl">üîπ PCNL</button>
                                 <button type="button" class="template-btn" data-template="turbt">üîπ TURBT</button>
                                 <button type="button" class="template-btn" data-template="other">‚úèÔ∏è Other Surgery</button>
                             </div>
                         </div>

                         <div class="form-row">
                             <div class="form-group">
                                 <label for="surgeryType">Surgery Type *</label>
                                 <input type="text" id="surgeryType" required placeholder="Enter surgery type">
                             </div>
                             <div class="form-group">
                                 <label for="surgeryDate">Surgery Date *</label>
                                 <input type="date" id="surgeryDate" required>
                             </div>
                         </div>

                         <div class="form-row">
                             <div class="form-group">
                                 <label for="surgeon">Surgeon *</label>
                                 <input type="text" id="surgeon" required placeholder="Enter surgeon name">
                             </div>
                             <div class="form-group">
                                 <label for="anesthesiaType">Anesthesia Type</label>
                                 <select id="anesthesiaType">
                                     <option value="">Select Type</option>
                                     <option value="General anesthesia">General</option>
                                     <option value="Spinal anesthesia">Spinal</option>
                                     <option value="Local anesthesia">Local</option>
                                     <option value="Local + sedation">Local + Sedation</option>
                                 </select>
                             </div>
                         </div>

                         <div class="form-group">
                             <label for="findings">Operative Findings</label>
                             <textarea id="findings" placeholder="Describe operative findings and observations..." style="height: 100px;"></textarea>
                         </div>

                         <div class="form-group">
                             <label for="operativeSteps">Operative Steps</label>
                             <textarea id="operativeSteps" placeholder="Detailed operative procedure steps..." style="height: 150px;"></textarea>
                         </div>

                         <div class="form-row">
                             <div class="form-group">
                                 <label for="complications">Complications</label>
                                 <textarea id="complications" placeholder="Any complications encountered..."></textarea>
                             </div>
                             <div class="form-group">
                                 <label for="bloodLoss">Estimated Blood Loss</label>
                                 <input type="text" id="bloodLoss" placeholder="e.g., <50 mL, 100-200 mL">
                             </div>
                         </div>

                         <button onclick="saveOperativeNote()" class="btn">Save Operative Note</button>
                         <button onclick="clearOperativeNoteForm()" class="btn btn-secondary">Clear Form</button>
                     </div>
                </div>
            </div>

            <div id="alerts"></div>
        </div>
    </div>

    <script>
        // Firebase configuration - Replace with your actual config
        const firebaseConfig = {
            apiKey: "your-api-key",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "your-app-id"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentPatientId = null;
        let patients = [];

        // Authentication functions
        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showError('loginError', 'Please enter both email and password.');
                return;
            }

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    document.getElementById('userEmail').textContent = userCredential.user.email;
                    loadPatients();
                    updateStats();
                })
                .catch((error) => {
                    showError('loginError', error.message);
                });
        }

        function logout() {
            auth.signOut().then(() => {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
                clearError('loginError');
            });
        }

        // Patient management functions
        function loadPatients() {
            db.collection('patients')
                .orderBy('name')
                .onSnapshot((snapshot) => {
                    patients = [];
                    const patientsList = document.getElementById('patientsList');
                    patientsList.innerHTML = '';

                    if (snapshot.empty) {
                        patientsList.innerHTML = '<p style="color: #666; text-align: center;">No patients found. Add your first patient!</p>';
                        return;
                    }

                    snapshot.forEach((doc) => {
                        const patient = { id: doc.id, ...doc.data() };
                        patients.push(patient);

                        const patientCard = document.createElement('div');
                        patientCard.className = 'patient-card';
                        patientCard.onclick = () => selectPatient(patient.id);
                        
                        patientCard.innerHTML = `
                            <div class="patient-name">${patient.name}</div>
                            <div class="patient-info">
                                Age: ${patient.age} | ${patient.gender}<br>
                                Diagnosis: ${patient.diagnosis || 'Not specified'}
                            </div>
                        `;
                        
                        patientsList.appendChild(patientCard);
                    });
                });
        }

        function selectPatient(patientId) {
            currentPatientId = patientId;
            const patient = patients.find(p => p.id === patientId);
            
            // Update UI
            document.querySelectorAll('.patient-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Show follow-up form
            document.getElementById('welcomeMessage').style.display = 'none';
            document.getElementById('addPatientForm').classList.remove('active');
            document.getElementById('followUpForm').classList.add('active');
            document.getElementById('selectedPatientName').textContent = `Follow-up for ${patient.name}`;
            
            // Set today's date as default
            document.getElementById('followUpDate').value = new Date().toISOString().split('T')[0];
        }

        function showAddPatientForm() {
            document.getElementById('welcomeMessage').style.display = 'none';
            document.getElementById('followUpForm').classList.remove('active');
            document.getElementById('addPatientForm').classList.add('active');
            currentPatientId = null;
            
            // Clear selected patient
            document.querySelectorAll('.patient-card').forEach(card => {
                card.classList.remove('selected');
            });
        }

        function addPatient() {
            const name = document.getElementById('patientName').value;
            const age = document.getElementById('patientAge').value;
            const gender = document.getElementById('patientGender').value;
            const phone = document.getElementById('patientPhone').value;
            const diagnosis = document.getElementById('patientDiagnosis').value;
            const notes = document.getElementById('patientNotes').value;
            
            if (!name || !age || !gender) {
                showAlert('Please fill in all required fields (Name, Age, Gender).', 'error');
                return;
            }

            const patientData = {
                name: name,
                age: parseInt(age),
                gender: gender,
                phone: phone,
                diagnosis: diagnosis,
                notes: notes,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: auth.currentUser.email
            };

            db.collection('patients').add(patientData)
                .then(() => {
                    showAlert('Patient added successfully!', 'success');
                    cancelAddPatient();
                    updateStats();
                })
                .catch((error) => {
                    showAlert('Error adding patient: ' + error.message, 'error');
                });
        }

        function cancelAddPatient() {
            document.getElementById('addPatientForm').classList.remove('active');
            document.getElementById('welcomeMessage').style.display = 'block';
            
            // Clear form
            document.getElementById('patientName').value = '';
            document.getElementById('patientAge').value = '';
            document.getElementById('patientGender').value = '';
            document.getElementById('patientPhone').value = '';
            document.getElementById('patientDiagnosis').value = '';
            document.getElementById('patientNotes').value = '';
        }

        // Follow-up functions
        function saveFollowUp() {
            if (!currentPatientId) {
                showAlert('Please select a patient first.', 'error');
                return;
            }

            const followUpData = {
                patientId: currentPatientId,
                date: document.getElementById('followUpDate').value,
                type: document.getElementById('followUpType').value,
                symptoms: document.getElementById('symptoms').value,
                painLevel: document.getElementById('painLevel').value,
                functionalStatus: document.getElementById('functionalStatus').value,
                medications: document.getElementById('medications').value,
                examination: document.getElementById('examination').value,
                assessment: document.getElementById('assessment').value,
                plan: document.getElementById('plan').value,
                nextAppointment: document.getElementById('nextAppointment').value,
                urgency: document.getElementById('urgency').value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: auth.currentUser.email
            };

            // Validate required fields
            if (!followUpData.date || !followUpData.type) {
                showAlert('Please fill in the follow-up date and type.', 'error');
                return;
            }

            db.collection('followUps').add(followUpData)
                .then(() => {
                    showAlert('Follow-up saved successfully!', 'success');
                    clearForm();
                    updateStats();
                })
                .catch((error) => {
                    showAlert('Error saving follow-up: ' + error.message, 'error');
                });
        }

        function clearForm() {
            const formFields = [
                'followUpDate', 'followUpType', 'symptoms', 'painLevel', 
                'functionalStatus', 'medications', 'examination', 'assessment', 
                'plan', 'nextAppointment', 'urgency'
            ];
            
            formFields.forEach(field => {
                const element = document.getElementById(field);
                if (element.type === 'date') {
                    element.value = new Date().toISOString().split('T')[0];
                } else {
                    element.value = '';
                }
            });
        }

        // Statistics functions
        function updateStats() {
            // Total patients
            db.collection('patients').get().then((snapshot) => {
                document.getElementById('totalPatients').textContent = snapshot.size;
            });

            // Follow-ups completed today
            const today = new Date().toISOString().split('T')[0];
            db.collection('followUps')
                .where('date', '==', today)
                .get()
                .then((snapshot) => {
                    document.getElementById('completedToday').textContent = snapshot.size;
                });

            // This is a simplified version - in a real app, you'd track pending follow-ups
            document.getElementById('pendingFollowUps').textContent = '0';
        }

        // Utility functions
        function showAlert(message, type) {
            const alertsContainer = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type === 'error' ? 'error' : 'success'}`;
            alert.textContent = message;
            
            alertsContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }

        function clearError(elementId) {
            const errorElement = document.getElementById(elementId);
            errorElement.classList.add('hidden');
        }

        // Initialize app
        auth.onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userEmail').textContent = user.email;
                loadPatients();
                updateStats();
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });

                 // Surgery Templates Database
         const surgeryTemplates = {
             urs_laser: {
                 name: "URS + Laser Lithotripsy",
                 surgeryType: "Ureteroscopic stone extraction with laser lithotripsy",
                 anesthesiaType: "General anesthesia",
                 findings: "Stone identified in ureter. Ureter mildly edematous. No perforation noted.",
                 operativeSteps: "1. Patient positioned in lithotomy\n2. Cystoscopy performed\n3. Guidewire placed\n4. Ureteroscope advanced\n5. Stone fragmented with laser\n6. Fragments retrieved\n7. DJ stent placed",
                 complications: "None encountered",
                 bloodLoss: "<50 mL"
             },
             flexible_urs: {
                 name: "Flexible Ureteroscopy",
                 surgeryType: "Flexible ureteroscopy with laser lithotripsy",
                 anesthesiaType: "General anesthesia",
                 findings: "Renal stones noted in calyces. Mucosa intact.",
                 operativeSteps: "1. Patient positioned in lithotomy\n2. Guidewire placed\n3. Access sheath inserted\n4. Flexible scope advanced\n5. Stones fragmented with laser\n6. DJ stent placed",
                 complications: "None encountered",
                 bloodLoss: "<50 mL"
             },
             turp: {
                 name: "TURP",
                 surgeryType: "Transurethral resection of prostate",
                 anesthesiaType: "Spinal anesthesia",
                 findings: "Enlarged prostate with prominent lobes. Bladder trabeculation noted.",
                 operativeSteps: "1. Patient positioned in lithotomy\n2. Cystoscopy performed\n3. Resection of prostate tissue\n4. Hemostasis achieved\n5. Catheter inserted",
                 complications: "None encountered",
                 bloodLoss: "200 mL"
             },
             orchiopexy: {
                 name: "Orchiopexy",
                 surgeryType: "Orchiopexy for undescended testis",
                 anesthesiaType: "General anesthesia",
                 findings: "Testis found in inguinal canal. Adequate cord length.",
                 operativeSteps: "1. Inguinal incision made\n2. Testis mobilized\n3. Hernia sac ligated\n4. Testis brought to scrotum\n5. Fixed in position",
                 complications: "None encountered",
                 bloodLoss: "<20 mL"
             },
             circumcision: {
                 name: "Circumcision",
                 surgeryType: "Circumcision using sleeve technique",
                 anesthesiaType: "Local anesthesia",
                 findings: "Phimosis present. Glans healthy.",
                 operativeSteps: "1. Local anesthetic administered\n2. Foreskin marked and excised\n3. Hemostasis achieved\n4. Skin edges approximated",
                 complications: "None encountered",
                 bloodLoss: "<10 mL"
             },
             pcnl: {
                 name: "PCNL",
                 surgeryType: "Percutaneous nephrolithotomy",
                 anesthesiaType: "General anesthesia",
                 findings: "Large renal calculus in pelvis. Moderate hydronephrosis.",
                 operativeSteps: "1. Patient positioned prone\n2. Percutaneous access obtained\n3. Tract dilated\n4. Stone fragmented and extracted\n5. Nephrostomy tube placed",
                 complications: "None encountered",
                 bloodLoss: "200 mL"
             },
             turbt: {
                 name: "TURBT",
                 surgeryType: "Transurethral resection of bladder tumor",
                 anesthesiaType: "Spinal anesthesia",
                 findings: "Bladder tumor noted on posterior wall. Ureteric orifices preserved.",
                 operativeSteps: "1. Cystoscopy performed\n2. Tumor resected systematically\n3. Base resected for staging\n4. Hemostasis achieved\n5. Catheter inserted",
                 complications: "None encountered",
                 bloodLoss: "100 mL"
             },
             other: {
                 name: "Other Surgery",
                 surgeryType: "",
                 anesthesiaType: "",
                 findings: "",
                 operativeSteps: "",
                 complications: "",
                 bloodLoss: ""
             }
         };

         let currentEditingNoteId = null;

         // Operative Notes Functions
         function showOperativeNotes() {
             if (!currentPatientId) {
                 showAlert('Please select a patient first.', 'error');
                 return;
             }
             
             document.getElementById('followUpForm').classList.remove('active');
             document.getElementById('addOperativeNoteView').classList.remove('active');
             document.getElementById('operativeNotesView').classList.add('active');
             loadOperativeNotes();
         }

         function showAddOperativeNote() {
             if (!currentPatientId) {
                 showAlert('Please select a patient first.', 'error');
                 return;
             }
             
             document.getElementById('followUpForm').classList.remove('active');
             document.getElementById('operativeNotesView').classList.remove('active');
             document.getElementById('addOperativeNoteView').classList.add('active');
             
             // Reset form
             clearOperativeNoteForm();
             document.getElementById('operativeNoteTitle').textContent = 'üî™ Add Operative Note';
             document.getElementById('surgeryDate').value = new Date().toISOString().split('T')[0];
             document.getElementById('surgeon').value = auth.currentUser.email.split('@')[0];
             currentEditingNoteId = null;
         }

         function backToPatientView() {
             document.getElementById('operativeNotesView').classList.remove('active');
             document.getElementById('addOperativeNoteView').classList.remove('active');
             document.getElementById('followUpForm').classList.add('active');
         }

         function loadOperativeNotes() {
             const container = document.getElementById('operativeNotesList');
             container.innerHTML = 'Loading operative notes...';
             
             db.collection('patients').doc(currentPatientId).collection('operativeNotes')
                 .orderBy('createdAt', 'desc')
                 .onSnapshot((snapshot) => {
                     if (snapshot.empty) {
                         container.innerHTML = `
                             <div class="no-operative-notes">
                                 <h4>üî™ No Operative Notes Yet</h4>
                                 <p>No operative notes have been recorded for this patient.</p>
                                 <button onclick="showAddOperativeNote()" class="btn btn-primary">‚ûï Add First Note</button>
                             </div>
                         `;
                         return;
                     }

                     let notesHtml = '';
                     snapshot.forEach((doc) => {
                         const note = doc.data();
                         const date = note.createdAt ? note.createdAt.toDate().toLocaleDateString() : 'Unknown date';
                         const time = note.createdAt ? note.createdAt.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                         
                         notesHtml += `
                             <div class="operative-note-card">
                                 <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                     <h4>${note.surgeryType || 'Operative Procedure'}</h4>
                                     <span style="font-size: 12px; color: #888;">${date} ${time}</span>
                                 </div>
                                 
                                 <div class="operative-note-header">
                                     <span><strong>Date:</strong> ${note.surgeryDate || 'N/A'}</span>
                                     <span><strong>Surgeon:</strong> ${note.surgeon || 'N/A'}</span>
                                     <span><strong>Anesthesia:</strong> ${note.anesthesiaType || 'N/A'}</span>
                                     <span><strong>Blood Loss:</strong> ${note.bloodLoss || 'N/A'}</span>
                                 </div>
                                 
                                 <div class="operative-section">
                                     <h5>Findings</h5>
                                     <p>${note.findings || 'Not documented'}</p>
                                 </div>
                                 
                                 <div class="operative-section">
                                     <h5>Operative Steps</h5>
                                     <p>${note.operativeSteps || 'Not documented'}</p>
                                 </div>
                                 
                                 <div class="operative-section">
                                     <h5>Complications</h5>
                                     <p>${note.complications || 'None reported'}</p>
                                 </div>
                                 
                                 <div class="operative-note-meta">
                                     <span>Created by: ${note.createdBy || 'Unknown'}</span>
                                     <div class="operative-note-actions">
                                         <button class="btn btn-sm btn-secondary" onclick="editOperativeNote('${doc.id}')" style="padding: 4px 8px; font-size: 12px;">
                                             ‚úèÔ∏è Edit
                                         </button>
                                         <button class="btn btn-sm btn-danger" onclick="deleteOperativeNote('${doc.id}')" style="padding: 4px 8px; font-size: 12px;">
                                             üóëÔ∏è Delete
                                         </button>
                                     </div>
                                 </div>
                             </div>
                         `;
                     });
                     
                     container.innerHTML = notesHtml;
                 });
         }

         function saveOperativeNote() {
             if (!currentPatientId) {
                 showAlert('Please select a patient first.', 'error');
                 return;
             }

             const surgeryType = document.getElementById('surgeryType').value;
             const surgeryDate = document.getElementById('surgeryDate').value;
             const surgeon = document.getElementById('surgeon').value;

             if (!surgeryType || !surgeryDate || !surgeon) {
                 showAlert('Please fill in all required fields (Surgery Type, Date, Surgeon).', 'error');
                 return;
             }

             const operativeNoteData = {
                 surgeryType: surgeryType,
                 surgeryDate: surgeryDate,
                 surgeon: surgeon,
                 anesthesiaType: document.getElementById('anesthesiaType').value,
                 findings: document.getElementById('findings').value,
                 operativeSteps: document.getElementById('operativeSteps').value,
                 complications: document.getElementById('complications').value,
                 bloodLoss: document.getElementById('bloodLoss').value,
                 patientId: currentPatientId,
                 createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                 createdBy: auth.currentUser.email
             };

             if (currentEditingNoteId) {
                 // Update existing note
                 db.collection('patients').doc(currentPatientId).collection('operativeNotes').doc(currentEditingNoteId).update({
                     ...operativeNoteData,
                     updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                 })
                 .then(() => {
                     showAlert('Operative note updated successfully!', 'success');
                     showOperativeNotes();
                 })
                 .catch((error) => {
                     showAlert('Error updating operative note: ' + error.message, 'error');
                 });
             } else {
                 // Add new note
                 db.collection('patients').doc(currentPatientId).collection('operativeNotes').add(operativeNoteData)
                 .then(() => {
                     showAlert('Operative note saved successfully!', 'success');
                     showOperativeNotes();
                 })
                 .catch((error) => {
                     showAlert('Error saving operative note: ' + error.message, 'error');
                 });
             }
         }

         function editOperativeNote(noteId) {
             currentEditingNoteId = noteId;
             
             db.collection('patients').doc(currentPatientId).collection('operativeNotes').doc(noteId).get()
             .then((doc) => {
                 if (doc.exists) {
                     const note = doc.data();
                     
                     // Switch to edit form
                     document.getElementById('operativeNotesView').classList.remove('active');
                     document.getElementById('addOperativeNoteView').classList.add('active');
                     document.getElementById('operativeNoteTitle').textContent = '‚úèÔ∏è Edit Operative Note';
                     
                     // Fill form with existing data
                     document.getElementById('surgeryType').value = note.surgeryType || '';
                     document.getElementById('surgeryDate').value = note.surgeryDate || '';
                     document.getElementById('surgeon').value = note.surgeon || '';
                     document.getElementById('anesthesiaType').value = note.anesthesiaType || '';
                     document.getElementById('findings').value = note.findings || '';
                     document.getElementById('operativeSteps').value = note.operativeSteps || '';
                     document.getElementById('complications').value = note.complications || '';
                     document.getElementById('bloodLoss').value = note.bloodLoss || '';
                 }
             })
             .catch((error) => {
                 showAlert('Error loading operative note: ' + error.message, 'error');
             });
         }

         function deleteOperativeNote(noteId) {
             if (confirm('Are you sure you want to delete this operative note? This action cannot be undone.')) {
                 db.collection('patients').doc(currentPatientId).collection('operativeNotes').doc(noteId).delete()
                 .then(() => {
                     showAlert('Operative note deleted successfully!', 'success');
                 })
                 .catch((error) => {
                     showAlert('Error deleting operative note: ' + error.message, 'error');
                 });
             }
         }

         function clearOperativeNoteForm() {
             document.getElementById('surgeryType').value = '';
             document.getElementById('surgeryDate').value = '';
             document.getElementById('surgeon').value = '';
             document.getElementById('anesthesiaType').value = '';
             document.getElementById('findings').value = '';
             document.getElementById('operativeSteps').value = '';
             document.getElementById('complications').value = '';
             document.getElementById('bloodLoss').value = '';
             
             // Remove active state from template buttons
             document.querySelectorAll('.template-btn').forEach(btn => {
                 btn.classList.remove('active');
             });
         }

         // Template button handler
         document.addEventListener('click', function(e) {
             if (e.target.classList.contains('template-btn')) {
                 const templateKey = e.target.getAttribute('data-template');
                 const template = surgeryTemplates[templateKey];
                 
                 if (template) {
                     // Remove active class from all buttons
                     document.querySelectorAll('.template-btn').forEach(btn => {
                         btn.classList.remove('active');
                     });
                     
                     // Add active class to clicked button
                     e.target.classList.add('active');
                     
                     // Fill form with template data
                     document.getElementById('surgeryType').value = template.surgeryType;
                     document.getElementById('anesthesiaType').value = template.anesthesiaType;
                     document.getElementById('findings').value = template.findings;
                     document.getElementById('operativeSteps').value = template.operativeSteps;
                     document.getElementById('complications').value = template.complications;
                     document.getElementById('bloodLoss').value = template.bloodLoss;
                     
                     // Set today's date and current user
                     document.getElementById('surgeryDate').value = new Date().toISOString().split('T')[0];
                     document.getElementById('surgeon').value = auth.currentUser.email.split('@')[0];
                 }
             }
         });

         // Allow Enter key to login
         document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && !document.getElementById('loginScreen').classList.contains('hidden')) {
                login();
            }
        });
    </script>
</body>
</html>
