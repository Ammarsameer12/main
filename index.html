<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urology Patient Follow-Up System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #1e40af;
            --primary-blue-light: #3b82f6;
            --primary-blue-dark: #1e3a8a;
            --secondary-teal: #0891b2;
            --success-green: #10b981;
            --warning-amber: #f59e0b;
            --danger-red: #ef4444;
            --neutral-50: #f8fafc;
            --neutral-100: #f1f5f9;
            --neutral-200: #e2e8f0;
            --neutral-300: #cbd5e1;
            --neutral-400: #94a3b8;
            --neutral-500: #64748b;
            --neutral-600: #475569;
            --neutral-700: #334155;
            --neutral-800: #1e293b;
            --neutral-900: #0f172a;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--neutral-50) 0%, var(--neutral-100) 100%);
            color: var(--neutral-700);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* Header/Navigation */
        .header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .logo i {
            font-size: 2rem;
            color: #60a5fa;
        }
        
        .nav-links {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #93c5fd;
            font-size: 0.9rem;
        }
        
        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Pages */
        .page {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 70vh;
        }
        
        .login-card {
            background: white;
            border-radius: 1rem;
            padding: 3rem;
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 450px;
            border: 1px solid var(--neutral-200);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .login-header h2 {
            color: var(--primary-blue);
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .login-header p {
            color: var(--neutral-500);
            font-size: 1rem;
        }
        
        .login-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary-blue-light), var(--secondary-teal));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            box-shadow: var(--shadow-lg);
        }
        
        .login-icon i {
            font-size: 2.5rem;
            color: white;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--neutral-700);
            font-size: 0.9rem;
        }
        
        .input-wrapper {
            position: relative;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.875rem 1rem 0.875rem 3rem;
            border: 2px solid var(--neutral-200);
            border-radius: 0.75rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--neutral-50);
        }
        
        .form-group select {
            padding-left: 1rem;
        }
        
        .form-group textarea {
            padding-left: 1rem;
            resize: vertical;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-blue-light);
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--neutral-400);
            font-size: 1.1rem;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--primary-blue-light), var(--primary-blue));
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-full {
            width: 100%;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--neutral-500), var(--neutral-600));
        }
        
        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Auth Messages */
        .auth-message {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.75rem;
            display: none;
            animation: fadeIn 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .auth-message.error {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .auth-message.success {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        
        .auth-message.info {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        
        .auth-message.warning {
            background: linear-gradient(135deg, #fefbf2, #fef3c7);
            color: #92400e;
            border: 1px solid #fde68a;
        }
        
        .demo-info {
            text-align: center;
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--neutral-50);
            border-radius: 0.5rem;
            border: 1px solid var(--neutral-200);
        }
        
        .demo-info p {
            color: var(--neutral-600);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .demo-info .highlight {
            color: var(--primary-blue);
            font-weight: 600;
        }
        
        /* Patient List Page Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
            text-align: center;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
            color: white;
        }
        
        .stat-icon.pre-op { background: linear-gradient(135deg, var(--warning-amber), #d97706); }
        .stat-icon.post-op { background: linear-gradient(135deg, var(--primary-blue-light), var(--primary-blue)); }
        .stat-icon.discharged { background: linear-gradient(135deg, var(--success-green), #059669); }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--neutral-800);
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            color: var(--neutral-600);
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .patients-header {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
        }
        
        .patients-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .patients-title h2 {
            color: var(--primary-blue);
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .btn-add {
            background: linear-gradient(135deg, var(--success-green), #059669);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
        }
        
        .search-bar {
            position: relative;
            max-width: 500px;
        }
        
        .search-bar input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: 2px solid var(--neutral-200);
            border-radius: 0.75rem;
            font-size: 1rem;
            background: var(--neutral-50);
            transition: all 0.3s ease;
        }
        
        .search-bar input:focus {
            outline: none;
            border-color: var(--primary-blue-light);
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .search-bar .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--neutral-400);
            font-size: 1.1rem;
        }
        
        .patients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1.5rem;
        }
        
        .patient-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .patient-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-blue), var(--secondary-teal));
        }
        
        .patient-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        
        .patient-main {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .patient-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 0.25rem;
        }
        
        .patient-mrn {
            color: var(--neutral-500);
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .patient-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .detail-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .detail-item i {
            color: var(--neutral-400);
            width: 16px;
        }
        
        .detail-item .label {
            color: var(--neutral-500);
            font-weight: 500;
        }
        
        .detail-item .value {
            color: var(--neutral-700);
            font-weight: 600;
        }
        
        .patient-surgery {
            background: var(--neutral-50);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid var(--neutral-200);
        }
        
        .surgery-type {
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 0.25rem;
        }
        
        .surgery-date {
            color: var(--neutral-600);
            font-size: 0.9rem;
        }
        
        .status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        
        .status.preop {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
        }
        
        .status.postop {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
        }
        
        .status.discharged {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
        }
        
        .status i {
            font-size: 0.8rem;
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .patients-grid {
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                padding: 0 1rem;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .container {
                padding: 1rem;
            }
            
            .patients-title {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .patients-grid {
                grid-template-columns: 1fr;
            }
            
            .patient-details {
                grid-template-columns: 1fr;
            }
            
            .login-card {
                padding: 2rem;
                margin: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            min-width: 300px;
            background: white;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            animation: slideInRight 0.3s ease-out;
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: var(--neutral-400);
            cursor: pointer;
            margin-left: auto;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }
        
        .notification-close:hover {
            background: var(--neutral-100);
            color: var(--neutral-600);
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-hospital-alt"></i>
                <span>Urology Follow-Up System</span>
            </div>
            <nav class="nav-links">
                <button id="loginNavBtn" class="nav-btn" onclick="showPage('login')">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <button id="patientsNavBtn" class="nav-btn" onclick="showPage('patients')" style="display: none;">
                    <i class="fas fa-users"></i> Patients
                </button>
                <button id="logoutNavBtn" class="nav-btn" onclick="handleLogout()" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                <div id="userInfo" class="user-info" style="display: none;">
                    <i class="fas fa-user-circle"></i>
                    <span id="userEmailDisplay"></span>
                </div>
            </nav>
        </div>
    </header>

    <div class="container">
        <!-- Login Page -->
        <div id="loginPage" class="page active">
            <div class="login-container">
                <div class="login-card">
                    <div class="login-header">
                        <div class="login-icon">
                            <i class="fas fa-user-md"></i>
                        </div>
                        <h2>Welcome Back</h2>
                        <p>Please sign in to access the patient management system</p>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <p style="color: var(--neutral-600); font-size: 0.9rem;">
                            <i class="fas fa-shield-alt"></i> 
                            Secure medical staff access
                        </p>
                    </div>
                    
                    <form id="loginForm" onsubmit="handleLogin(event)">
                        <div class="form-group">
                            <label for="loginEmail">Email Address</label>
                            <div class="input-wrapper">
                                <i class="fas fa-envelope input-icon"></i>
                                <input type="email" id="loginEmail" required placeholder="doctor@hospital.com">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="loginPassword">Password</label>
                            <div class="input-wrapper">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="loginPassword" required placeholder="Enter your password">
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-full" id="loginButton">
                            <i class="fas fa-sign-in-alt"></i>
                            Sign In Securely
                        </button>
                    </form>
                    
                    <div id="loginMessage" class="auth-message"></div>
                    
                    <div class="demo-info">
                        <p><i class="fas fa-rocket"></i> <span class="highlight">Powered by Supabase</span></p>
                        <p>Real-time database and secure authentication</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Patient List Page -->
        <div id="patientsPage" class="page">
            <!-- Stats Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon pre-op">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-number" id="preOpCount">0</div>
                    <div class="stat-label">Pre-Operative</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon post-op">
                        <i class="fas fa-procedures"></i>
                    </div>
                    <div class="stat-number" id="postOpCount">0</div>
                    <div class="stat-label">Post-Operative</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon discharged">
                        <i class="fas fa-home"></i>
                    </div>
                    <div class="stat-number" id="dischargedCount">0</div>
                    <div class="stat-label">Discharged</div>
                </div>
            </div>
            
            <!-- Header Section -->
            <div class="patients-header">
                <div class="patients-title">
                    <h2>
                        <i class="fas fa-clipboard-list"></i>
                        Patient Management
                    </h2>
                    <button class="btn btn-add" onclick="showPage('addPatient')">
                        <i class="fas fa-plus"></i>
                        Add New Patient
                    </button>
                </div>
                
                <div class="search-bar">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="patientSearchInput" placeholder="Search by name, MRN, room number, or surgery type..." 
                           oninput="searchPatients(this.value)">
                </div>
            </div>
            
            <!-- Patient Cards -->
            <div class="patients-grid" id="patientsGrid">
                <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: var(--neutral-500);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>Loading patients...</p>
                </div>
            </div>
        </div>

        <!-- Enhanced Add Patient Form Page -->
        <div id="addPatientPage" class="page">
            <div style="max-width: 1200px; margin: 0 auto;">
                <div style="background: white; border-radius: 1rem; padding: 2rem; box-shadow: var(--shadow-xl); border: 1px solid var(--neutral-200);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="color: var(--primary-blue); font-size: 2rem; font-weight: 700;">
                            <i class="fas fa-user-plus"></i>
                            Complete Patient Assessment
                        </h2>
                        <button onclick="showPage('patients')" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i>
                            Back to List
                        </button>
                    </div>
                    
                    <form id="addPatientForm" onsubmit="handleAddPatient(event)">
                        <!-- Demographics Section -->
                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: var(--primary-blue); margin-bottom: 1rem; border-bottom: 2px solid var(--neutral-200); padding-bottom: 0.5rem;">
                                <i class="fas fa-user"></i> Patient Demographics
                            </h3>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label for="patientName">Full Name *</label>
                                    <div class="input-wrapper">
                                        <i class="fas fa-user input-icon"></i>
                                        <input type="text" id="patientName" required placeholder="John Smith">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="patientMRN">MRN *</label>
                                    <div class="input-wrapper">
                                        <i class="fas fa-id-card input-icon"></i>
                                        <input type="text" id="patientMRN" required placeholder="MRN12345">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="patientAge">Age *</label>
                                    <div class="input-wrapper">
                                        <i class="fas fa-birthday-cake input-icon"></i>
                                        <input type="number" id="patientAge" required min="1" max="120" placeholder="65">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="patientGender">Gender *</label>
                                    <select id="patientGender" required style="width: 100%; padding: 0.875rem; border: 2px solid var(--neutral-200); border-radius: 0.75rem; font-size: 1rem; background: var(--neutral-50);">
                                        <option value="">Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="patientPhone">Phone Number</label>
                                    <div class="input-wrapper">
                                        <i class="fas fa-phone input-icon"></i>
                                        <input type="tel" id="patientPhone" placeholder="+1-555-0123">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="roomNumber">Room Number</label>
                                    <div class="input-wrapper">
                                        <i class="fas fa-bed input-icon"></i>
                                        <input type="text" id="roomNumber" placeholder="201A">
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div class="form-group">
                                    <label for="admissionDate">Admission Date *</label>
                                    <div class="input-wrapper">
                                        <i class="fas fa-calendar-plus input-icon"></i>
                                        <input type="date" id="admissionDate" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="emergencyContact">Emergency Contact</label>
                                    <div class="input-wrapper">
                                        <i class="fas fa-phone-alt input-icon"></i>
                                        <input type="text" id="emergencyContact" placeholder="Name: +1-555-0123">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Clinical Assessment Section -->
                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: var(--primary-blue); margin-bottom: 1rem; border-bottom: 2px solid var(--neutral-200); padding-bottom: 0.5rem;">
                                <i class="fas fa-stethoscope"></i> Clinical Assessment
                            </h3>
                            
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label for="presentingComplaint">Presenting Complaint *</label>
                                <textarea id="presentingComplaint" required rows="3" 
                                         style="width: 100%; padding: 0.875rem; border: 2px solid var(--neutral-200); border-radius: 0.75rem; font-size: 1rem; background: var(--neutral-50); resize: vertical;"
                                         placeholder="Chief complaint and history of present illness..."></textarea>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label for="pastMedicalHistory">Past Medical History (PMH)</label>
                                    <textarea id="pastMedicalHistory" rows="3" 
                                             style="width: 100%; padding: 0.875rem; border: 2px solid var(--neutral-200); border-radius: 0.75rem; font-size: 1rem; background: var(--neutral-50); resize: vertical;"
                                             placeholder="DM, HTN, CAD, etc..."></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="pastSurgicalHistory">Past Surgical History (PSH)</label>
                                    <textarea id="pastSurgicalHistory" rows="3" 
                                             style="width: 100%; padding: 0.875rem; border: 2px solid var(--neutral-200); border-radius: 0.75rem; font-size: 1rem; background: var(--neutral-50); resize: vertical;"
                                             placeholder="Previous surgeries with dates..."></textarea>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div class="form-group">
                                    <label for="allergies">Allergies</label>
                                    <div class="input-wrapper">
                                        <i class="fas fa-exclamation-triangle input-icon"></i>
                                        <input type="text" id="allergies" placeholder="NKDA or list allergies...">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="currentMedications">Current Medications</label>
                                    <textarea id="currentMedications" rows="2" 
                                             style="width: 100%; padding: 0.875rem; border: 2px solid var(--neutral-200); border-radius: 0.75rem; font-size: 1rem; background: var(--neutral-50); resize: vertical;"
                                             placeholder="List current medications with doses..."></textarea>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-top: 1rem;">
                                <label for="physicalExam">Physical Examination</label>
                                <textarea id="physicalExam" rows="4" 
                                         style="width: 100%; padding: 0.875rem; border: 2px solid var(--neutral-200); border-radius: 0.75rem; font-size: 1rem; background: var(--neutral-50); resize: vertical;"
                                         placeholder="General appearance, vital signs, system examination findings..."></textarea>
                            </div>
                        </div>
                        
                        <!-- Laboratory & Imaging Section -->
                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: var(--primary-blue); margin-bottom: 1rem; border-bottom: 2px solid var(--neutral-200); padding-bottom: 0.5rem;">
                                <i class="fas fa-vials"></i> Laboratory & Imaging
                            </h3>
                            
                            <!-- Common Lab Values Grid -->
                            <div style="background: var(--neutral-50); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem; border: 1px solid var(--neutral-200);">
                                <h4 style="color: var(--neutral-700); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-flask"></i> Common Lab Values
                                </h4>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem;">
                                    <div class="form-group">
                                        <label for="hemoglobin">Hemoglobin (g/dL)</label>
                                        <input type="number" id="hemoglobin" step="0.1" placeholder="12.5" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--neutral-300); border-radius: 0.5rem; font-size: 0.9rem;">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="wbc">WBC (×10³/μL)</label>
                                        <input type="number" id="wbc" step="0.1" placeholder="7.5" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--neutral-300); border-radius: 0.5rem; font-size: 0.9rem;">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="platelets">Platelets (×10³/μL)</label>
                                        <input type="number" id="platelets" placeholder="250" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--neutral-300); border-radius: 0.5rem; font-size: 0.9rem;">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="creatinine">Creatinine (mg/dL)</label>
                                        <input type="number" id="creatinine" step="0.01" placeholder="1.0" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--neutral-300); border-radius: 0.5rem; font-size: 0.9rem;">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="bun">BUN (mg/dL)</label>
                                        <input type="number" id="bun" placeholder="15" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--neutral-300); border-radius: 0.5rem; font-size: 0.9rem;">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="psa">PSA (ng/mL)</label>
                                        <input type="number" id="psa" step="0.01" placeholder="2.5" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--neutral-300); border-radius: 0.5rem; font-size: 0.9rem;">
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label for="labSummary">Additional Lab Results</label>
                                    <textarea id="labSummary" rows="3" 
                                             style="width: 100%; padding: 0.875rem; border: 2px solid var(--neutral-200); border-radius: 0.75rem; font-size: 1rem; background: var(--neutral-50); resize: vertical;"
                                             placeholder="PT/INR, electrolytes, urinalysis, cultures, etc..."></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="imagingSummary">Imaging Summary</label>
                                    <textarea id="imagingSummary" rows="3" 
                                             style="width: 100%; padding: 0.875rem; border: 2px solid var(--neutral-200); border-radius: 0.75rem; font-size: 1rem; background: var(--neutral-50); resize: vertical;"
                                             placeholder="CT, MRI, Ultrasound, X-ray findings..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Surgery Information Section -->
                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: var(--primary-blue); margin-bottom: 1rem; border-bottom: 2px solid var(--neutral-200); padding-bottom: 0.5rem;">
                                <i class="fas fa-scalpel"></i> Surgery Information
                            </h3>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label for="surgeryType">Surgery Type</label>
                                    <select id="surgeryType" onchange="fillSurgeryTemplate()" style="width: 100%; padding: 0.875rem; border: 2px solid var(--neutral-200); border-radius: 0.75rem; font-size: 1rem; background: var(--neutral-50);">
                                        <option value="">Select Surgery</option>
                                        <option value="TURP">TURP (Transurethral Resection of Prostate)</option>
                                        <option value="URS">URS (Ureteroscopy)</option>
                                        <option value="PCNL">PCNL (Percutaneous Nephrolithotomy)</option>
                                        <option value="Circumcision">Circumcision</option>
                                        <option value="Nephrectomy">Nephrectomy</option>
                                        <option value="Cystoscopy">Cystoscopy</option>
                                        <option value="Prostatectomy">Radical Prostatectomy</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="surgeryDate">Surgery Date</label>
                                    <div class="input-wrapper">
                                        <i class="fas fa-calendar input-icon"></i>
                                        <input type="date" id="surgeryDate">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="surgeryTime">Surgery Time</label>
                                    <div class="input-wrapper">
                                        <i class="fas fa-clock input-icon"></i>
                                        <input type="time" id="surgeryTime">
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div class="form-group">
                                    <label for="surgeon">Primary Surgeon</label>
                                    <div class="input-wrapper">
                                        <i class="fas fa-user-md input-icon"></i>
                                        <input type="text" id="surgeon" placeholder="Dr. Smith">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="anesthesiaType">Anesthesia Type</label>
                                    <select id="anesthesiaType" style="width: 100%; padding: 0.875rem; border: 2px solid var(--neutral-200); border-radius: 0.75rem; font-size: 1rem; background: var(--neutral-50);">
                                        <option value="">Select Type</option>
                                        <option value="General">General Anesthesia</option>
                                        <option value="Spinal">Spinal Anesthesia</option>
                                        <option value="Epidural">Epidural</option>
                                        <option value="Local">Local Anesthesia</option>
                                        <option value="MAC">MAC (Monitored Anesthesia Care)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Initial Assessment & Plan -->
                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: var(--primary-blue); margin-bottom: 1rem; border-bottom: 2px solid var(--neutral-200); padding-bottom: 0.5rem;">
                                <i class="fas fa-clipboard-check"></i> Assessment & Plan
                            </h3>
                            
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label for="clinicalAssessment">Clinical Assessment</label>
                                <textarea id="clinicalAssessment" rows="3" 
                                         style="width: 100%; padding: 0.875rem; border: 2px solid var(--neutral-200); border-radius: 0.75rem; font-size: 1rem; background: var(--neutral-50); resize: vertical;"
                                         placeholder="Working diagnosis and clinical impression..."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="treatmentPlan">Treatment Plan</label>
                                <textarea id="treatmentPlan" rows="3" 
                                         style="width: 100%; padding: 0.875rem; border: 2px solid var(--neutral-200); border-radius: 0.75rem; font-size: 1rem; background: var(--neutral-50); resize: vertical;"
                                         placeholder="Planned interventions, medications, monitoring..."></textarea>
                            </div>
                        </div>
                        
                        <!-- Submit Section -->
                        <div style="border-top: 2px solid var(--neutral-200); padding-top: 2rem;">
                            <div id="addPatientMessage" class="auth-message"></div>
                            
                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button type="button" onclick="showPage('patients')" class="btn btn-secondary">
                                    <i class="fas fa-times"></i>
                                    Cancel
                                </button>
                                <button type="submit" class="btn" id="addPatientButton">
                                    <i class="fas fa-save"></i>
                                    Save Complete Assessment
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Detail Page -->
        <div id="patientDetailPage" class="page">
            <div style="max-width: 1400px; margin: 0 auto;">
                <!-- Patient Header -->
                <div style="background: white; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; box-shadow: var(--shadow-xl); border: 1px solid var(--neutral-200);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <button onclick="showPage('patients')" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i>
                            Back to Patients
                        </button>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn" onclick="showOperativeNoteForm()" style="background: linear-gradient(135deg, var(--success-green), #059669);">
                                <i class="fas fa-scalpel"></i>
                                Add Operative Note
                            </button>
                            <button class="btn" onclick="showNotification('Post-operative logging coming in Part 6! 🚧', 'info')" style="background: linear-gradient(135deg, var(--primary-blue-light), var(--primary-blue));">
                                <i class="fas fa-plus"></i>
                                Add Post-Op Entry
                            </button>
                            <button class="btn" onclick="showNotification('Patient editing coming soon! 📝', 'info')" style="background: linear-gradient(135deg, var(--warning-amber), #d97706);">
                                <i class="fas fa-edit"></i>
                                Edit Info
                            </button>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h1 id="detailPatientName" style="color: var(--primary-blue); font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">
                                Loading...
                            </h1>
                            <div style="display: flex; flex-wrap: wrap; gap: 2rem; margin-bottom: 1rem;">
                                <span id="detailMRN" style="color: var(--neutral-600); font-size: 1.1rem; font-weight: 600;"></span>
                                <span id="detailAge" style="color: var(--neutral-600); font-size: 1.1rem;"></span>
                                <span id="detailGender" style="color: var(--neutral-600); font-size: 1.1rem;"></span>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 2rem;">
                                <span id="detailRoom" style="color: var(--neutral-600); font-size: 1rem;"></span>
                                <span id="detailAdmissionDate" style="color: var(--neutral-600); font-size: 1rem;"></span>
                                <span id="detailPhone" style="color: var(--neutral-600); font-size: 1rem;"></span>
                            </div>
                        </div>
                        <div id="detailStatus"></div>
                    </div>
                </div>

                <!-- Main Content Grid -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
                    <!-- Left Column - Main Details -->
                    <div style="display: flex; flex-direction: column; gap: 2rem;">
                        <!-- Presenting Complaint -->
                        <div style="background: white; border-radius: 1rem; padding: 1.5rem; box-shadow: var(--shadow-lg); border: 1px solid var(--neutral-200);">
                            <h3 style="color: var(--primary-blue); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-file-medical-alt"></i>
                                Presenting Complaint
                            </h3>
                            <p id="detailPresentingComplaint" style="color: var(--neutral-700); line-height: 1.6; white-space: pre-wrap;">
                                Loading...
                            </p>
                        </div>

                        <!-- Assessment & Plan -->
                        <div style="background: white; border-radius: 1rem; padding: 1.5rem; box-shadow: var(--shadow-lg); border: 1px solid var(--neutral-200);">
                            <h3 style="color: var(--primary-blue); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-stethoscope"></i>
                                Assessment & Plan
                            </h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                <div>
                                    <h4 style="color: var(--neutral-700); margin-bottom: 0.5rem; font-size: 1rem; font-weight: 600;">Clinical Assessment</h4>
                                    <p id="detailClinicalAssessment" style="color: var(--neutral-600); line-height: 1.6; white-space: pre-wrap;"></p>
                                </div>
                                <div>
                                    <h4 style="color: var(--neutral-700); margin-bottom: 0.5rem; font-size: 1rem; font-weight: 600;">Treatment Plan</h4>
                                    <p id="detailTreatmentPlan" style="color: var(--neutral-600); line-height: 1.6; white-space: pre-wrap;"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Medical History -->
                        <div style="background: white; border-radius: 1rem; padding: 1.5rem; box-shadow: var(--shadow-lg); border: 1px solid var(--neutral-200);">
                            <h3 style="color: var(--primary-blue); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-history"></i>
                                Medical History
                            </h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                <div>
                                    <h4 style="color: var(--neutral-700); margin-bottom: 0.5rem;">Past Medical History</h4>
                                    <p id="detailPMH" style="color: var(--neutral-600); line-height: 1.5; margin-bottom: 1rem;"></p>
                                    
                                    <h4 style="color: var(--neutral-700); margin-bottom: 0.5rem;">Allergies</h4>
                                    <p id="detailAllergies" style="color: var(--neutral-600); line-height: 1.5;"></p>
                                </div>
                                <div>
                                    <h4 style="color: var(--neutral-700); margin-bottom: 0.5rem;">Past Surgical History</h4>
                                    <p id="detailPSH" style="color: var(--neutral-600); line-height: 1.5; margin-bottom: 1rem;"></p>
                                    
                                    <h4 style="color: var(--neutral-700); margin-bottom: 0.5rem;">Current Medications</h4>
                                    <p id="detailMedications" style="color: var(--neutral-600); line-height: 1.5;"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Physical Examination -->
                        <div style="background: white; border-radius: 1rem; padding: 1.5rem; box-shadow: var(--shadow-lg); border: 1px solid var(--neutral-200);">
                            <h3 style="color: var(--primary-blue); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-user-md"></i>
                                Physical Examination
                            </h3>
                            <p id="detailPhysicalExam" style="color: var(--neutral-700); line-height: 1.6; white-space: pre-wrap;"></p>
                        </div>
                    </div>

                    <!-- Right Column - Quick Info & Labs -->
                    <div style="display: flex; flex-direction: column; gap: 2rem;">
                        <!-- Quick Stats -->
                        <div style="background: white; border-radius: 1rem; padding: 1.5rem; box-shadow: var(--shadow-lg); border: 1px solid var(--neutral-200);">
                            <h3 style="color: var(--primary-blue); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-chart-line"></i>
                                Quick Stats
                            </h3>
                            <div style="display: grid; gap: 1rem;">
                                <div style="background: var(--neutral-50); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-blue);" id="daysAdmitted">0</div>
                                    <div style="font-size: 0.9rem; color: var(--neutral-600);">Days Admitted</div>
                                </div>
                                <div style="background: var(--neutral-50); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                                    <div style="font-size: 1.2rem; font-weight: 600;" id="surgeryCountdown">Not scheduled</div>
                                    <div style="font-size: 0.9rem; color: var(--neutral-600);">Surgery Status</div>
                                </div>
                            </div>
                        </div>

                        <!-- Surgery Information -->
                        <div style="background: white; border-radius: 1rem; padding: 1.5rem; box-shadow: var(--shadow-lg); border: 1px solid var(--neutral-200);">
                            <h3 style="color: var(--primary-blue); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-scalpel"></i>
                                Surgery Details
                            </h3>
                            <div style="space-y: 0.75rem;">
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--neutral-200);">
                                    <span style="color: var(--neutral-600); font-weight: 500;">Type:</span>
                                    <span id="detailSurgeryType" style="color: var(--neutral-800); font-weight: 600;">-</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--neutral-200);">
                                    <span style="color: var(--neutral-600); font-weight: 500;">Date:</span>
                                    <span id="detailSurgeryDate" style="color: var(--neutral-800); font-weight: 600;">-</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--neutral-200);">
                                    <span style="color: var(--neutral-600); font-weight: 500;">Time:</span>
                                    <span id="detailSurgeryTime" style="color: var(--neutral-800); font-weight: 600;">-</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--neutral-200);">
                                    <span style="color: var(--neutral-600); font-weight: 500;">Surgeon:</span>
                                    <span id="detailSurgeon" style="color: var(--neutral-800); font-weight: 600;">-</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                    <span style="color: var(--neutral-600); font-weight: 500;">Anesthesia:</span>
                                    <span id="detailAnesthesia" style="color: var(--neutral-800); font-weight: 600;">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Laboratory Results -->
                        <div style="background: white; border-radius: 1rem; padding: 1.5rem; box-shadow: var(--shadow-lg); border: 1px solid var(--neutral-200);">
                            <h3 style="color: var(--primary-blue); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-vials"></i>
                                Lab Results
                            </h3>
                            <div id="detailLabResults" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                <!-- Lab values will be populated here -->
                            </div>
                            
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--neutral-200);">
                                <h4 style="color: var(--neutral-700); margin-bottom: 0.5rem; font-size: 0.9rem;">Additional Labs</h4>
                                <p id="detailAdditionalLabs" style="color: var(--neutral-600); font-size: 0.85rem; line-height: 1.4;"></p>
                            </div>
                        </div>

                        <!-- Imaging Studies -->
                        <div style="background: white; border-radius: 1rem; padding: 1.5rem; box-shadow: var(--shadow-lg); border: 1px solid var(--neutral-200);">
                            <h3 style="color: var(--primary-blue); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-x-ray"></i>
                                Imaging
                            </h3>
                            <p id="detailImaging" style="color: var(--neutral-600); font-size: 0.9rem; line-height: 1.5;"></p>
                        </div>

                        <!-- Post-Op Section (Preview) -->
                        <div style="background: linear-gradient(135deg, var(--neutral-50), white); border-radius: 1rem; padding: 1.5rem; box-shadow: var(--shadow-lg); border: 1px solid var(--neutral-200);">
                            <h3 style="color: var(--primary-blue); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-procedures"></i>
                                Post-Op Monitoring
                            </h3>
                            <div style="text-align: center; color: var(--neutral-500);">
                                <i class="fas fa-clock" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                                <p style="margin-bottom: 1rem; font-size: 0.9rem;">Daily vitals and progress notes</p>
                                <button class="btn btn-secondary" onclick="showNotification('Post-operative logging coming in Part 5! 🚧', 'info')" style="font-size: 0.85rem; padding: 0.5rem 1rem;">
                                    <i class="fas fa-plus"></i>
                                    Coming Soon
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Operative Notes Page -->
<div id="operativeNotePage" class="page">
    <div style="max-width: 1200px; margin: 0 auto;">
        <div style="background: white; border-radius: 1rem; padding: 2rem; box-shadow: var(--shadow-xl); border: 1px solid var(--neutral-200);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="color: var(--primary-blue); font-size: 2rem; font-weight: 700;">
                    <i class="fas fa-scalpel"></i>
                    Operative Note
                </h2>
                <button onclick="showPage('patientDetail')" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    Back to Patient
                </button>
            </div>
            
            <!-- Surgery Type Selection -->
            <div style="margin-bottom: 2rem; padding: 1.5rem; background: var(--neutral-50); border-radius: 0.75rem; border: 1px solid var(--neutral-200);">
                <h3 style="color: var(--primary-blue); margin-bottom: 1rem;">
                    <i class="fas fa-list"></i> Select Surgery Type
                </h3>
                <div class="form-group">
                    <select id="operativeTemplate" onchange="loadOperativeTemplate()" style="width: 100%; padding: 0.875rem; border: 2px solid var(--neutral-200); border-radius: 0.75rem; font-size: 1rem; background: white;">
                        <option value="">Select Surgery Type</option>
                        <option value="urs_stone">URS - Ureteric Stone Extraction</option>
                        <option value="flexible_urs">Flexible URS - Renal Stones</option>
                        <option value="turp">TURP - Transurethral Resection of Prostate</option>
                        <option value="orchiopexy">Orchiopexy for Undescended Testis</option>
                        <option value="inguinal_hernia">Inguinal Hernia Repair</option>
                        <option value="pediatric_hernia">Pediatric Inguinal Hernia</option>
                        <option value="hydrocelectomy">Hydrocelectomy</option>
                        <option value="varicocelectomy">Microscopic Varicocelectomy</option>
                        <option value="urethrotomy">Optical Internal Urethrotomy</option>
                        <option value="circumcision">Surgical Circumcision</option>
                        <option value="pcnl">Percutaneous Nephrolithotomy (PCNL)</option>
                        <option value="turbt">TURBT - Bladder Tumor Resection</option>
                        <option value="radical_nephrectomy">Radical Nephrectomy</option>
                        <option value="partial_nephrectomy">Partial Nephrectomy</option>
                        <option value="radical_prostatectomy">Radical Prostatectomy</option>
                        <option value="other">Other Surgery (Manual Entry)</option>
                    </select>
                </div>
            </div>
            
            <!-- Operative Note Form -->
            <form id="operativeNoteForm" onsubmit="handleSaveOperativeNote(event)">
                <div id="operativeNoteContent">
                    <p style="text-align: center; color: var(--neutral-500); padding: 2rem;">
                        Please select a surgery type above to load the operative note template.
                    </p>
                </div>
                
                <div style="border-top: 2px solid var(--neutral-200); padding-top: 2rem; margin-top: 2rem;">
                    <div id="operativeNoteMessage" class="auth-message"></div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" onclick="showPage('patientDetail')" class="btn btn-secondary">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                        <button type="submit" class="btn" id="saveOperativeNoteButton">
                            <i class="fas fa-save"></i>
                            Save Operative Note
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://xqsfajxxpcxsguqezcpr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhxc2Zhanh4cGN4c2d1cWV6Y3ByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0ODEzOTQsImV4cCI6MjA2OTA1NzM5NH0.-cd5LQ0CSB9DNenAhjgALhTg8JRBo8gS4MPwEWN4CMI';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('🚀 Supabase initialized successfully!');

        // Global State
        let currentUser = null;
        let isLoggedIn = false;
        let allPatients = [];
        let currentPatient = null;

        // Add this function with your other functions
function showOperativeNoteForm() {
    if (!currentPatient) {
        showNotification('No patient selected', 'error');
        return;
    }
    showPage('operativeNote');
}

        function loadOperativeTemplate() {
    const templateSelect = document.getElementById('operativeTemplate');
    const contentDiv = document.getElementById('operativeNoteContent');
    const selectedTemplate = templateSelect.value;
    
    if (!selectedTemplate) {
        contentDiv.innerHTML = `
            <p style="text-align: center; color: var(--neutral-500); padding: 2rem;">
                Please select a surgery type above to load the operative note template.
            </p>
        `;
        return;
    }
    
            const templates = {
    'urs_stone': {
        procedure: 'Right/Left ureteroscopic stone extraction with Thulium laser lithotripsy and DJ stent placement',
        anesthesia: 'General anesthesia',
        position: 'Lithotomy position',
        findings: 'A single/multiple stone(s) were identified in the mid/distal ureter. The ureter was mildly edematous. No evidence of perforation or extravasation was noted.',
        steps: `1. After induction of general anesthesia, the patient was placed in lithotomy position and prepped and draped in sterile fashion.
2. A safety guidewire was introduced into the ureter under cystoscopic guidance.
3. A semi-rigid ureteroscope was advanced to visualize the ureteric stone.
4. Thulium laser lithotripsy was performed to dust and fragment the stone.
5. Fragments were retrieved with a basket as needed.
6. A retrograde pyelogram was performed to assess the upper tract and confirm integrity.
7. A 5/6 Fr DJ stent was inserted over the guidewire with the distal curl in the bladder and proximal coil in the renal pelvis.
8. Hemostasis was confirmed, and instruments were withdrawn.`,
        complications: 'None encountered intraoperatively',
        ebl: '<50 mL'
    },
    
    'flexible_urs': {
        procedure: 'Unilateral/Bilateral flexible ureteroscopy with laser lithotripsy and DJ stent placement',
        anesthesia: 'General anesthesia',
        position: 'Lithotomy position',
        findings: 'Multiple/single stone(s) noted within the renal pelvis and calyces, most commonly lower pole. Mucosa was intact with mild edema. No extravasation or ureteral injury observed.',
        steps: `1. Under general anesthesia, the patient was placed in the lithotomy position and prepped and draped in sterile fashion.
2. A safety guidewire was inserted into the ureter under cystoscopic guidance.
3. A ureteral access sheath was introduced where feasible.
4. A flexible ureteroscope was advanced to the renal pelvis, and all calyces were systematically inspected.
5. Stones were visualized and fragmented using Thulium laser (dusting and/or fragmentation technique).
6. Fragments were actively retrieved using a nitinol basket where appropriate.
7. Complete inspection of all calyces was performed to exclude residual fragments.
8. A 5/6 Fr DJ stent was inserted in the treated side(s) under fluoroscopic or endoscopic guidance.
9. Hemostasis was verified, and all instruments were removed.`,
        complications: 'None encountered intraoperatively',
        ebl: '<50 mL'
    },
    
    'turp': {
        procedure: 'Transurethral resection of the prostate (TURP)',
        anesthesia: 'Spinal anesthesia',
        position: 'Lithotomy position',
        findings: 'Enlarged prostate gland with prominent lateral and median lobes protruding into the bladder. Mild trabeculation of bladder noted. No bladder stones or tumors observed. Ureteric orifices identified bilaterally and preserved.',
        steps: `1. Under spinal anesthesia, the patient was placed in the lithotomy position, prepped, and draped in sterile fashion.
2. Initial cystoscopy was performed to assess the bladder and visualize the prostatic enlargement and ureteric orifices.
3. A monopolar/bipolar resectoscope was introduced.
4. Resection began at the median lobe, followed by the lateral lobes, proceeding in a systematic fashion down to the surgical capsule.
5. Bladder neck was resected and smoothed.
6. Complete hemostasis was achieved using coagulation current.
7. Prostatic chips were evacuated using an Ellik evacuator.
8. A 22/24 Fr three-way Foley catheter was inserted and continuous bladder irrigation was started.`,
        complications: 'None encountered intraoperatively',
        ebl: 'Approximately 200 mL'
    },
    
    'orchiopexy': {
        procedure: 'Right/Left inguinal exploration and orchiopexy',
        anesthesia: 'General anesthesia',
        position: 'Supine position',
        findings: 'Testis found in the inguinal canal/at the internal ring. Spermatic cord of adequate length with no significant tension after mobilization. Hernial sac present/absent.',
        steps: `1. Under general anesthesia, the patient was placed in the supine position and prepped and draped in sterile fashion.
2. A standard inguinal incision was made over the inguinal canal.
3. The external oblique aponeurosis was opened, and the cord structures were isolated.
4. The undescended testis was identified and mobilized with high dissection of the cord structures.
5. A patent processus vaginalis was identified and ligated at the level of the internal ring (if present).
6. The testis was brought down to the scrotum through a subdartos pouch via a separate scrotal incision.
7. The testis was fixed in position using absorbable sutures.
8. Hemostasis was ensured, and the inguinal and scrotal wounds were closed in layers.`,
        complications: 'None encountered intraoperatively',
        ebl: 'Minimal (<20 mL)'
    },
    
    'inguinal_hernia': {
        procedure: 'Right/Left inguinal hernia repair with mesh (Lichtenstein hernioplasty)',
        anesthesia: 'Spinal anesthesia / General anesthesia',
        position: 'Supine position',
        findings: 'Indirect/direct inguinal hernia sac identified. No bowel compromise. Hernia contents reducible. Spermatic cord and surrounding structures preserved.',
        steps: `1. Under spinal/general anesthesia, the patient was placed in the supine position and prepped and draped in sterile fashion.
2. An oblique inguinal incision was made, and the external oblique aponeurosis was incised.
3. The hernia sac was identified and dissected from the cord structures.
4. The sac was opened, contents inspected and reduced into the peritoneal cavity.
5. The sac was transfixed and excised.
6. A polypropylene mesh was fashioned and placed over the posterior wall of the inguinal canal, covering the deep ring.
7. The mesh was fixed to the pubic tubercle medially, to the inguinal ligament inferiorly, and to the conjoint tendon superiorly.
8. The external oblique aponeurosis was closed over the cord, followed by skin closure.`,
        complications: 'None encountered intraoperatively',
        ebl: '<50 mL'
    },
    
    'pediatric_hernia': {
        procedure: 'Right/Left inguinal herniotomy',
        anesthesia: 'General anesthesia',
        position: 'Supine position',
        findings: 'Indirect hernia sac extending through the deep inguinal ring. Hernia contents reducible. No ischemic changes observed. Testis and cord structures were normal.',
        steps: `1. Under general anesthesia, the patient was positioned supine and prepped and draped in a sterile fashion.
2. A transverse/oblique skin crease incision was made over the inguinal region.
3. The external oblique aponeurosis was incised, and the inguinal canal was opened.
4. The hernia sac was identified lateral to the cord structures and carefully dissected free.
5. The sac was opened, and its contents were reduced into the peritoneal cavity.
6. The sac was transfixed and ligated high at the level of the internal ring using absorbable suture.
7. Excess sac distal to the ligature was excised.
8. The inguinal canal was closed, and the wound was closed in layers with absorbable sutures.`,
        complications: 'None encountered intraoperatively',
        ebl: 'Minimal (<10 mL)'
    },
    
    'hydrocelectomy': {
        procedure: 'Right/Left hydrocelectomy (Jaboulay procedure)',
        anesthesia: 'Spinal anesthesia / General anesthesia',
        position: 'Supine position',
        findings: 'Large/simple hydrocele involving the tunica vaginalis. Clear/straw-colored fluid encountered. No thickening or suspicious pathology of the tunica or testis. Spermatic cord structures normal.',
        steps: `1. After induction of spinal/general anesthesia, the patient was positioned supine and prepped and draped in sterile fashion.
2. A transverse scrotal incision was made over the hydrocele.
3. Dissection was carried down to the tunica vaginalis.
4. The hydrocele sac was opened, and approximately [specify] mL of fluid was drained.
5. The sac was inspected and everted (Jaboulay technique), and redundant tunica was excised if needed.
6. Hemostasis was secured.
7. The testis was replaced into the scrotum, and the dartos and skin layers were closed using absorbable sutures.`,
        complications: 'None encountered intraoperatively',
        ebl: 'Minimal (<20 mL)'
    },
    
    'varicocelectomy': {
        procedure: 'Subinguinal microscopic varicocelectomy – Right/Left side',
        anesthesia: 'General anesthesia',
        position: 'Supine position',
        findings: 'Dilated and tortuous pampiniform plexus veins identified. Testicular artery and lymphatics preserved. No evidence of testicular atrophy or abnormal pathology.',
        steps: `1. Under general anesthesia, the patient was placed in the supine position, prepped, and draped in sterile fashion.
2. A 2–3 cm subinguinal incision was made just below the external inguinal ring.
3. The spermatic cord was identified and isolated on a vascular sling.
4. Under operative microscope magnification (×10–25), the cord structures were carefully dissected.
5. The testicular artery was identified using micro-Doppler and preserved.
6. Dilated veins of the pampiniform plexus were isolated, doubly ligated, and divided.
7. Lymphatic channels were preserved to minimize the risk of postoperative hydrocele.
8. Hemostasis was achieved. The cord was returned to its anatomical position.
9. The incision was closed in layers using absorbable sutures.`,
        complications: 'None encountered intraoperatively',
        ebl: 'Minimal (<10–20 mL)'
    },
    
    'urethrotomy': {
        procedure: 'Optical internal urethrotomy for anterior urethral stricture',
        anesthesia: 'Spinal anesthesia / General anesthesia',
        position: 'Lithotomy position',
        findings: 'A short segment stricture was identified in the bulbar urethra. The urethral mucosa appeared fibrotic at the site of narrowing. No false passages or additional strictures were identified distally.',
        steps: `1. Under spinal/general anesthesia, the patient was placed in lithotomy position and prepped and draped in sterile fashion.
2. A cystourethroscope was gently advanced until resistance was encountered at the level of the stricture.
3. The stricture was confirmed endoscopically and a cold-knife urethrotomy was performed at the 12 o'clock position.
4. The incision was extended until the urethral lumen was adequately patent and the bladder was entered.
5. The bladder was inspected and found to be normal.
6. A 16/18 Fr Foley catheter was passed easily into the bladder without resistance.
7. The catheter was secured and left in situ.`,
        complications: 'None encountered intraoperatively',
        ebl: 'Minimal (<30 mL)'
    },
    
    'circumcision': {
        procedure: 'Circumcision using sleeve technique',
        anesthesia: 'Local anesthesia with/without sedation',
        position: 'Supine position',
        findings: 'Phimosis/paraphimosis/redundant foreskin. No signs of infection or inflammation. Glans penis appeared healthy and intact.',
        steps: `1. The patient was placed in the supine position and prepped and draped in sterile fashion.
2. Local anesthetic was infiltrated at the base of the penis (penile block) with or without dorsal nerve block.
3. The preputial adhesions were released and the foreskin fully retracted.
4. Markings were made for the sleeve excision at the junction of inner and outer prepuce.
5. The foreskin was incised circumferentially and excised carefully, preserving the glans and frenulum.
6. Hemostasis was achieved with electrocautery or ligatures.
7. The edges of the skin were approximated with interrupted or running absorbable sutures (e.g., 4-0 Vicryl Rapide).
8. Sterile dressing was applied.`,
        complications: 'None encountered intraoperatively',
        ebl: 'Minimal (<10 mL)'
    },
    
    'pcnl': {
        procedure: 'Percutaneous nephrolithotomy – Right/Left kidney',
        anesthesia: 'General anesthesia',
        position: 'Initial lithotomy, then prone position',
        findings: 'Large renal calculus occupying the renal pelvis with/without extension into calyces. Moderate hydronephrosis. No collecting system perforation or bleeding encountered during the procedure.',
        steps: `1. Under general anesthesia, the patient was initially positioned in lithotomy position and prepped and draped in sterile fashion.
2. A cystoscopy was performed and a 5–6 Fr open-ended ureteric catheter was advanced into the renal pelvis under fluoroscopic guidance.
3. The catheter was secured and connected to contrast for subsequent pelvicalyceal system opacification.
4. The patient was then repositioned into prone position and re-prepped and draped.
5. Percutaneous access was obtained into a posterior lower/middle calyx under fluoroscopic (or ultrasound) guidance.
6. The tract was dilated using serial fascial dilators or a balloon dilator, and a 30 Fr Amplatz sheath was placed.
7. A rigid nephroscope was introduced through the sheath.
8. Stones were visualized and fragmented using ultrasonic/pneumatic lithotripter or laser.
9. Fragments were extracted using forceps or suction, and a flexible nephroscope was used to inspect all calyces for residual stones.
10. A nephrostomy tube was inserted. DJ stent was placed if indicated.
11. Hemostasis was confirmed and dressing applied.`,
        complications: 'None encountered intraoperatively',
        ebl: 'Approximately 100–300 mL'
    },
    
    'turbt': {
        procedure: 'Transurethral resection of bladder tumor (TURBT)',
        anesthesia: 'Spinal anesthesia / General anesthesia',
        position: 'Lithotomy position',
        findings: 'Solitary/multiple papillary sessile tumor(s) located on the bladder wall — most commonly on lateral wall/trigone/posterior wall. Tumor appeared superficial/deep. No gross extravesical extension. Ureteric orifices identified and preserved.',
        steps: `1. Under spinal/general anesthesia, the patient was placed in lithotomy position, prepped, and draped in sterile fashion.
2. Diagnostic cystoscopy was performed to localize and characterize the bladder lesion(s).
3. A resectoscope was introduced, and the tumor was resected systematically down to the detrusor muscle.
4. Base of the tumor was resected deeply to include detrusor for histopathologic staging.
5. Bleeding points were coagulated using monopolar/bipolar current.
6. Resected tissue was evacuated using an Ellik evacuator and sent for histopathology.
7. The bladder was thoroughly irrigated, inspected for completeness of resection, and ureteric orifices were visualized.
8. A 22 Fr three-way Foley catheter was inserted, and continuous bladder irrigation was started.`,
        complications: 'None encountered intraoperatively',
        ebl: '50–150 mL'
    },
    
    'radical_nephrectomy': {
        procedure: 'Right/Left open/laparoscopic/robotic radical nephrectomy',
        anesthesia: 'General anesthesia',
        position: 'Flank or lateral decubitus position',
        findings: 'Renal mass involving upper/mid/lower pole without evidence of gross local invasion beyond Gerota\'s fascia. Renal vein and artery visualized. No significant lymphadenopathy or adrenal involvement (unless removed en bloc).',
        steps: `1. Under general anesthesia, the patient was positioned in lateral decubitus (or flank) position, prepped, and draped in sterile fashion.
2. A flank incision (for open) or transperitoneal/retroperitoneal ports were placed (for laparoscopic/robotic approach).
3. The colon was reflected medially to expose the kidney.
4. Gerota's fascia was incised and the kidney was mobilized circumferentially.
5. Renal artery and vein were individually dissected, ligated, and divided.
6. The ureter was ligated and divided distally.
7. The entire kidney along with surrounding perinephric fat and Gerota's fascia was removed en bloc.
8. The adrenal gland was preserved or removed based on intraoperative findings.
9. Hemostasis was secured. A drain was placed if indicated.
10. The incision/port sites were closed in layers.`,
        complications: 'None encountered intraoperatively',
        ebl: '150–400 mL'
    },
    
    'partial_nephrectomy': {
        procedure: 'Right/Left open/laparoscopic/robotic partial nephrectomy',
        anesthesia: 'General anesthesia',
        position: 'Lateral decubitus or flank position',
        findings: 'Renal mass measuring [__] cm located on the upper/mid/lower pole. The tumor was well-circumscribed and confined to the renal parenchyma without gross evidence of renal vein or perinephric extension.',
        steps: `1. Under general anesthesia, the patient was placed in lateral decubitus position and prepped and draped in sterile fashion.
2. A flank incision was made (open) or laparoscopic/robotic ports were placed (minimally invasive).
3. The colon was reflected medially to expose the kidney.
4. The renal artery (± vein) was identified and clamped to achieve temporary renal ischemia.
5. The tumor was excised with a rim of normal parenchyma using cold scissors or electrocautery.
6. Renorrhaphy was performed in two layers: Inner layer to control collecting system and small vessels, Outer cortical layer to approximate renal parenchyma (with sliding-clip technique or bolsters).
7. The clamp was released and hemostasis was confirmed.
8. The specimen was sent for histopathology.
9. A drain was placed in the renal bed if indicated.
10. The incision/port sites were closed in layers.`,
        complications: 'None encountered intraoperatively',
        ebl: '100–300 mL'
    },
    
    'radical_prostatectomy': {
        procedure: 'Open/Laparoscopic/Robotic-assisted radical prostatectomy with bilateral pelvic lymph node dissection (if indicated)',
        anesthesia: 'General anesthesia',
        position: 'Supine/Low lithotomy with Trendelenburg position',
        findings: 'Prostate of normal/enlarged size. No gross extracapsular extension. Seminal vesicles intact. No gross pelvic lymphadenopathy observed.',
        steps: `1. Under general anesthesia, the patient was positioned in supine or low lithotomy with steep Trendelenburg, prepped and draped in sterile fashion.
2. A lower midline incision was made (open) or ports were inserted for robotic/laparoscopic access.
3. The bladder was mobilized and the endopelvic fascia was incised bilaterally.
4. The dorsal venous complex was ligated and divided.
5. Bladder neck was dissected and transected, preserving ureteric orifices.
6. The prostate was dissected posteriorly off the rectum.
7. Seminal vesicles and vas deferens were mobilized and divided.
8. The neurovascular bundles were preserved or resected based on oncologic criteria.
9. The apex of the prostate and urethra were divided with careful identification of urethral margins.
10. Pelvic lymph node dissection was performed bilaterally (if indicated).
11. A watertight urethrovesical anastomosis was constructed using absorbable sutures.
12. A pelvic drain was placed. A 16 Fr Foley catheter was inserted and secured.`,
        complications: 'None encountered intraoperatively',
        ebl: '250–500 mL'
    }
                'ureteric_reimplantation': {
    procedure: 'Right/Left ureteric reimplantation (extravesical/Lich-Gregoir or intravesical/Cohen technique)',
    anesthesia: 'General anesthesia',
    position: 'Supine position',
    findings: 'Distal ureteric narrowing/refluxing ureter with/without associated hydronephrosis. Bladder capacity adequate. No gross bladder wall abnormalities.',
    steps: `1. Under general anesthesia, the patient was positioned supine, prepped, and draped in sterile fashion.
2. A Pfannenstiel or lower midline incision was made to access the bladder.
3. The bladder was exposed extraperitoneally.
4. The affected ureter was mobilized down to its distal segment, and the diseased portion was excised.
5. For extravesical reimplantation (Lich-Gregoir): A detrusor tunnel was created on the bladder wall, The ureter was implanted into the bladder mucosa, The detrusor muscle was re-approximated over the ureter to create an antireflux tunnel.
6. For intravesical reimplantation (Cohen): The bladder was opened transversely, A submucosal tunnel was created from the new ureteral orifice to the contralateral wall, The ureter was tunneled and anastomosed to the bladder mucosa.
7. A double-J stent was placed in most cases.
8. The bladder was closed in two layers.
9. A pelvic drain and Foley catheter were inserted and secured.`,
    complications: 'None encountered intraoperatively',
    ebl: '50–150 mL'
},

'pyeloplasty': {
    procedure: 'Right/Left open/laparoscopic/robotic Anderson-Hynes dismembered pyeloplasty',
    anesthesia: 'General anesthesia',
    position: 'Flank or lateral decubitus position',
    findings: 'Ureteropelvic junction obstruction with a dilated renal pelvis and narrow/angulated UPJ. No crossing vessel / Crossing vessel present and preserved.',
    steps: `1. Under general anesthesia, the patient was placed in lateral decubitus position and prepped and draped in sterile fashion.
2. A flank incision (open) or ports were placed (laparoscopic/robotic approach).
3. The colon was reflected to expose the kidney and UPJ.
4. The renal pelvis and proximal ureter were dissected and mobilized.
5. The obstructed UPJ segment was excised.
6. The ureter was spatulated laterally and a tension-free anastomosis was fashioned with the renal pelvis (Anderson-Hynes technique).
7. A double-J stent was inserted antegrade into the ureter and bladder.
8. The anastomosis was completed using interrupted or continuous absorbable sutures.
9. Hemostasis was achieved. A drain was placed adjacent to the anastomosis.
10. The incision/port sites were closed in layers.`,
    complications: 'None encountered intraoperatively',
    ebl: '50–150 mL'
},

'cystolitholapaxy': {
    procedure: 'Transurethral cystolitholapaxy for vesical stone(s)',
    anesthesia: 'Spinal anesthesia / General anesthesia',
    position: 'Lithotomy position',
    findings: 'One/multiple bladder stone(s) visualized, measuring approximately [__] cm. Bladder mucosa intact. Ureteric orifices visualized and preserved. No associated bladder tumor or foreign body seen.',
    steps: `1. The patient was positioned in lithotomy under spinal/general anesthesia, prepped, and draped in sterile fashion.
2. A cystoscope was introduced into the bladder, and stone(s) were identified and assessed for size, number, and mobility.
3. A lithotripsy device (pneumatic/ultrasonic/laser) was introduced via a working sheath.
4. The stone(s) were fragmented under direct vision.
5. Stone fragments were irrigated and removed with a stone evacuator (e.g., Ellik evacuator).
6. Complete clearance of the bladder was confirmed cystoscopically.
7. Ureteric orifices were inspected.
8. A 20/22 Fr Foley catheter was inserted, and irrigation was initiated if needed.`,
    complications: 'None encountered intraoperatively',
    ebl: 'Minimal (<50 mL)'
},

'radical_orchiectomy': {
    procedure: 'Right/Left radical inguinal orchiectomy',
    anesthesia: 'General anesthesia / Spinal anesthesia',
    position: 'Supine position',
    findings: 'Testis appeared enlarged/firm with no evidence of scrotal wall involvement. Spermatic cord structures were thickened/normal. No gross invasion of surrounding tissue.',
    steps: `1. The patient was positioned supine under general/spinal anesthesia and prepped and draped in sterile fashion.
2. A groin incision was made along the inguinal canal.
3. The external oblique aponeurosis was opened to access the inguinal canal.
4. The spermatic cord was isolated at the internal ring, clamped, divided, and ligated using high ligation technique.
5. The testis, epididymis, and spermatic cord were delivered en bloc.
6. Hemostasis was achieved.
7. The inguinal canal and skin were closed in layers.
8. The specimen was sent for histopathology.`,
    complications: 'None encountered intraoperatively',
    ebl: '<50 mL'
},

'simple_orchiectomy': {
    procedure: 'Right/Left simple orchiectomy',
    anesthesia: 'General anesthesia / Spinal anesthesia',
    position: 'Supine position',
    findings: 'Testis was atrophic/painful/nonfunctional. Spermatic cord appeared normal. No associated masses or abnormal findings.',
    steps: `1. The patient was placed supine under anesthesia, prepped, and draped in sterile fashion.
2. A transverse scrotal incision was made over the affected testis.
3. The testis and epididymis were delivered through the incision.
4. The spermatic cord was clamped and ligated at the level of the external ring.
5. The testis and attached cord were excised.
6. Hemostasis was confirmed, and the scrotal wound was closed in layers using absorbable sutures.
7. Dressing was applied.`,
    complications: 'None encountered intraoperatively',
    ebl: 'Minimal (<20–30 mL)'
},

'scrotal_exploration': {
    procedure: 'Right/Left scrotal exploration ± detorsion, orchiopexy, or orchiectomy',
    anesthesia: 'General anesthesia',
    position: 'Supine position',
    findings: 'Testis was found to be twisted by [__] degrees / no torsion noted. Testis appeared viable / congested / ischemic. Tunica vaginalis contained clear fluid / hemorrhagic fluid. Spermatic cord was twisted / intact. No evidence of tumor or abscess.',
    steps: `1. Under general anesthesia, the patient was placed in supine position, prepped, and draped in sterile fashion.
2. A transverse midline or hemiscrotal incision was made over the affected side.
3. The tunica vaginalis was opened, and the testis was delivered into the wound.
4. The testis and spermatic cord were inspected.
5. If torsion was found: the cord was untwisted, and warm sponges applied for 10–15 minutes to assess viability.
6. If viable: orchiopexy was performed using non-absorbable sutures.
7. If non-viable: orchiectomy was performed and the cord ligated.
8. Contralateral orchiopexy was performed through a separate incision (if indicated).
9. Hemostasis was achieved.
10. The dartos and skin were closed in layers using absorbable sutures.
11. Sterile dressing applied.`,
    complications: 'None encountered intraoperatively',
    ebl: 'Minimal (<30 mL)'
},

'suprapubic_cystostomy': {
    procedure: 'Suprapubic cystostomy for urinary diversion',
    anesthesia: 'Local anesthesia ± sedation / Spinal anesthesia / General anesthesia',
    position: 'Supine position',
    findings: 'Distended bladder identified with adequate capacity. No evidence of bladder tumor, clot retention, or bladder wall abnormality on preoperative evaluation.',
    steps: `1. Under [local/spinal/general] anesthesia, the patient was positioned supine, prepped, and draped in sterile fashion.
2. The bladder was filled via a urethral catheter (if patent) or guided by ultrasound.
3. A 2–3 cm transverse infraumbilical incision was made above the pubic symphysis.
4. Dissection was carried through subcutaneous tissues and rectus sheath to the bladder dome.
5. The bladder was punctured using a trocar/cystostomy set under direct palpation or ultrasound guidance.
6. Urine was aspirated to confirm entry, and a Foley catheter (14–16 Fr) was introduced through the tract into the bladder.
7. The catheter balloon was inflated and traction applied to secure the catheter.
8. The skin was closed around the tube and secured with sutures or adhesive dressing.
9. Urine drained freely, and catheter patency was confirmed.`,
    complications: 'None encountered intraoperatively',
    ebl: 'Minimal (<10 mL)'
},

'penile_prosthesis': {
    procedure: 'Insertion of inflatable/malleable penile prosthesis',
    anesthesia: 'General anesthesia / Spinal anesthesia',
    position: 'Supine position',
    findings: 'Corpora cavernosa were of adequate length and dilatable. No fibrosis or significant corporal scarring. Urethra intact. No signs of infection or abnormal anatomy.',
    steps: `1. Under anesthesia, the patient was positioned supine and prepped and draped in sterile fashion with a wide perineal/genital field.
2. A penile/scrotal or infrapubic incision was made depending on surgeon's approach.
3. Corporotomies were made bilaterally over the corpora cavernosa.
4. Corporal bodies were dilated proximally and distally with Hegar dilators.
5. Measurement was taken, and appropriate-sized inflatable/malleable prosthesis cylinders were inserted bilaterally.
6. If inflatable type: Pump was placed in the scrotum, Reservoir placed in the retropubic space, Tubing was connected and tested for function and leaks.
7. Corporotomies were closed with absorbable sutures.
8. Wound was irrigated with antibiotic solution, and incision closed in layers.
9. A compressive dressing and Foley catheter were applied.`,
    complications: 'None encountered intraoperatively',
    ebl: '50–100 mL'
},

'bladder_neck_incision': {
    procedure: 'Transurethral bladder neck incision for bladder outlet obstruction',
    anesthesia: 'Spinal anesthesia / General anesthesia',
    position: 'Lithotomy position',
    findings: 'Narrow bladder neck with high bladder neck elevation and no significant prostatic enlargement. Ureteric orifices were clearly identified and distant from the incision site.',
    steps: `1. Under anesthesia, the patient was positioned in lithotomy and prepped and draped in sterile fashion.
2. A cystoscopic evaluation was performed, confirming a tight bladder neck with no obstructing median or lateral prostate lobes.
3. A resectoscope with cold knife or Collins knife was introduced.
4. A deep incision was made at the 5 o'clock and 7 o'clock positions through the bladder neck muscle fibers until perivesical fat was seen.
5. Hemostasis was achieved with coagulation as needed.
6. The bladder was inspected to ensure no injury to the trigone or ureteric orifices.
7. A 16–18 Fr Foley catheter was inserted and bladder irrigation was initiated if necessary.`,
    complications: 'None encountered intraoperatively',
    ebl: 'Minimal (<30 mL)'
},

'urethroplasty': {
    procedure: 'Excision and primary anastomosis urethroplasty / Buccal mucosal graft urethroplasty for anterior urethral stricture',
    anesthesia: 'General anesthesia / Spinal anesthesia',
    position: 'Lithotomy position (or extended lithotomy for perineal access)',
    findings: 'Segmental bulbar urethral stricture measuring [__] cm. Healthy urethral mucosa proximal and distal to the stricture. Corpus spongiosum intact.',
    steps: `1. The patient was placed in the lithotomy position and prepped and draped in sterile fashion.
2. A midline perineal incision was made and the bulbar urethra was dissected and fully mobilized.
3. The strictured segment was identified and excised (for primary anastomosis).
4. If length <2 cm: The healthy ends of the urethra were spatulated and a tension-free end-to-end anastomosis was performed with interrupted absorbable sutures.
5. If length >2–3 cm (not amenable to anastomosis): A buccal mucosal graft was harvested and quilted onto the corpora (dorsal onlay or ventral onlay), and urethrotomy edges were sutured to the graft.
6. A 16 Fr silicone catheter was passed across the repair.
7. Hemostasis was achieved and a drain placed in the perineal wound.
8. The wound was closed in layers.`,
    complications: 'None encountered intraoperatively',
    ebl: '50–150 mL'
}
};
            
    if (selectedTemplate === 'other') {
        // Show empty form for manual entry
        contentDiv.innerHTML = createOperativeNoteForm('', '', '', '', '', '', '');
    } else if (templates[selectedTemplate]) {
        const template = templates[selectedTemplate];
        contentDiv.innerHTML = createOperativeNoteForm(
            template.procedure,
            template.anesthesia,
            template.position,
            template.findings,
            template.steps,
            template.complications,
            template.ebl
        );
    }
}

function createOperativeNoteForm(procedure, anesthesia, position, findings, steps, complications, ebl) {
    return `
        <div style="display: grid; gap: 1.5rem;">
            <div class="form-group">
                <label for="procedurePerformed">Procedure Performed *</label>
                <textarea id="procedurePerformed" rows="2" required 
                         style="width: 100%; padding: 0.875rem; border: 2px solid var(--neutral-200); border-radius: 0.75rem; font-size: 1rem; background: var(--neutral-50); resize: vertical;"
                         placeholder="Describe the procedure performed">${procedure}</textarea>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label for="anesthesiaType">Anesthesia Type</label>
                    <input type="text" id="anesthesiaType" value="${anesthesia}"
                           style="width: 100%; padding: 0.875rem; border: 2px solid var(--neutral-200); border-radius: 0.75rem; font-size: 1rem; background: var(--neutral-50);"
                           placeholder="General, Spinal, Local...">
                </div>
                
                <div class="form-group">
                    <label for="patientPosition">Patient Position</label>
                    <input type="text" id="patientPosition" value="${position}"
                           style="width: 100%; padding: 0.875rem; border: 2px solid var(--neutral-200); border-radius: 0.75rem; font-size: 1rem; background: var(--neutral-50);"
                           placeholder="Lithotomy, Supine, Prone...">
                </div>
                
                <div class="form-group">
                    <label for="estimatedBloodLoss">Estimated Blood Loss</label>
                    <input type="text" id="estimatedBloodLoss" value="${ebl}"
                           style="width: 100%; padding: 0.875rem; border: 2px solid var(--neutral-200); border-radius: 0.75rem; font-size: 1rem; background: var(--neutral-50);"
                           placeholder="<50 mL, 200 mL...">
                </div>
            </div>
            
            <div class="form-group">
                <label for="operativeFindings">Operative Findings</label>
                <textarea id="operativeFindings" rows="3"
                         style="width: 100%; padding: 0.875rem; border: 2px solid var(--neutral-200); border-radius: 0.75rem; font-size: 1rem; background: var(--neutral-50); resize: vertical;"
                         placeholder="Describe the operative findings">${findings}</textarea>
            </div>
            
            <div class="form-group">
                <label for="operativeSteps">Operative Steps *</label>
                <textarea id="operativeSteps" rows="8" required
                         style="width: 100%; padding: 0.875rem; border: 2px solid var(--neutral-200); border-radius: 0.75rem; font-size: 1rem; background: var(--neutral-50); resize: vertical;"
                         placeholder="Describe the step-by-step procedure">${steps}</textarea>
            </div>
            
            <div class="form-group">
                <label for="complications">Complications</label>
                <textarea id="complications" rows="2"
                         style="width: 100%; padding: 0.875rem; border: 2px solid var(--neutral-200); border-radius: 0.75rem; font-size: 1rem; background: var(--neutral-50); resize: vertical;"
                         placeholder="None encountered intraoperatively">${complications}</textarea>
            </div>
        </div>
    `;
}
        
        // Page Navigation
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show requested page
            const targetPage = document.getElementById(pageId + 'Page');
            if (targetPage) {
                targetPage.classList.add('active');
                
                // Load patients when showing patients page
                if (pageId === 'patients' && isLoggedIn) {
                    loadPatients();
                }
            }
        }

        // Authentication Functions
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const button = document.getElementById('loginButton');
            
            // Show loading
            const originalContent = button.innerHTML;
            button.innerHTML = '<div class="loading"></div> Signing In...';
            button.disabled = true;
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                showMessage('loginMessage', `Welcome back, ${data.user.email}!`, 'success');
                
            } catch (error) {
                console.error('Login error:', error);
                showMessage('loginMessage', getErrorMessage(error.message), 'error');
                
                // Reset button
                button.innerHTML = originalContent;
                button.disabled = false;
            }
        }

        async function handleLogout() {
            if (!confirm('Are you sure you want to logout?')) return;
            
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                showNotification('Logged out successfully', 'info');
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Error logging out', 'error');
            }
        }

        // Enhanced Patient Functions
        async function loadPatients() {
            try {
                const { data: patients, error } = await supabase
                    .from('patients')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allPatients = patients || [];
                displayPatients(allPatients);
                updateStatistics(allPatients);

            } catch (error) {
                console.error('Error loading patients:', error);
                showNotification('Error loading patients: ' + error.message, 'error');
                displayEmptyState();
            }
        }

        function displayPatients(patients) {
            const grid = document.getElementById('patientsGrid');
            
            if (patients.length === 0) {
                displayEmptyState();
                return;
            }

            grid.innerHTML = patients.map(patient => createPatientCard(patient)).join('');
        }

        function displayEmptyState() {
            const grid = document.getElementById('patientsGrid');
            grid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: var(--neutral-500);">
                    <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <h3>No Patients Found</h3>
                    <p>Add your first patient to get started</p>
                    <button class="btn" onclick="showPage('addPatient')" style="margin-top: 1rem;">
                        <i class="fas fa-plus"></i>
                        Add First Patient
                    </button>
                </div>
            `;
        }

        function createPatientCard(patient) {
            const statusClass = patient.status.replace('-', '');
            return `
                <div class="patient-card" onclick="viewPatient('${patient.id}')">
                    <div class="patient-main">
                        <div>
                            <div class="patient-name">${patient.name}</div>
                            <div class="patient-mrn">MRN: ${patient.mrn}</div>
                        </div>
                        <span class="status ${statusClass}">
                            <i class="fas ${getStatusIcon(patient.status)}"></i>
                            ${getStatusText(patient.status)}
                        </span>
                    </div>
                    
                    <div class="patient-details">
                        <div class="detail-item">
                            <i class="fas fa-bed"></i>
                            <span class="label">Room:</span>
                            <span class="value">${patient.room_number || 'Not assigned'}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-birthday-cake"></i>
                            <span class="label">Age:</span>
                            <span class="value">${patient.age} years</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-phone"></i>
                            <span class="label">Contact:</span>
                            <span class="value">${patient.phone || 'Not provided'}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-calendar"></i>
                            <span class="label">Admitted:</span>
                            <span class="value">${formatDate(patient.admission_date) || 'Not set'}</span>
                        </div>
                    </div>
                    
                    <div class="patient-surgery">
                        <div class="surgery-type">
                            <i class="fas fa-scalpel"></i>
                            ${patient.surgery_type || 'Surgery not scheduled'}
                        </div>
                        <div class="surgery-date">
                            <i class="fas fa-clock"></i>
                            ${formatSurgeryDateTime(patient.surgery_date, patient.surgery_time)}
                        </div>
                    </div>
                </div>
            `;
        }

        // Enhanced Add Patient Function with Comprehensive Data
        async function handleAddPatient(event) {
            event.preventDefault();
            
            const button = document.getElementById('addPatientButton');
            const form = document.getElementById('addPatientForm');
            
            // Get comprehensive form data
            const patientData = {
                // Demographics
                name: document.getElementById('patientName').value.trim(),
                mrn: document.getElementById('patientMRN').value.trim(),
                age: parseInt(document.getElementById('patientAge').value),
                gender: document.getElementById('patientGender').value,
                phone: document.getElementById('patientPhone').value.trim() || null,
                room_number: document.getElementById('roomNumber').value.trim() || null,
                admission_date: document.getElementById('admissionDate').value || new Date().toISOString().split('T')[0],
                emergency_contact: document.getElementById('emergencyContact').value.trim() || null,
                
                // Clinical Assessment
                presenting_complaint: document.getElementById('presentingComplaint').value.trim(),
                past_medical_history: document.getElementById('pastMedicalHistory').value.trim() || null,
                past_surgical_history: document.getElementById('pastSurgicalHistory').value.trim() || null,
                allergies: document.getElementById('allergies').value.trim() || null,
                current_medications: document.getElementById('currentMedications').value.trim() || null,
                physical_exam: document.getElementById('physicalExam').value.trim() || null,
                
                // Laboratory Values
                hemoglobin: parseFloat(document.getElementById('hemoglobin').value) || null,
                wbc: parseFloat(document.getElementById('wbc').value) || null,
                platelets: parseInt(document.getElementById('platelets').value) || null,
                creatinine: parseFloat(document.getElementById('creatinine').value) || null,
                bun: parseInt(document.getElementById('bun').value) || null,
                psa: parseFloat(document.getElementById('psa').value) || null,
                lab_summary: document.getElementById('labSummary').value.trim() || null,
                imaging_summary: document.getElementById('imagingSummary').value.trim() || null,
                
                // Surgery Information
                surgery_type: document.getElementById('surgeryType').value || null,
                surgery_date: document.getElementById('surgeryDate').value || null,
                surgery_time: document.getElementById('surgeryTime').value || null,
                surgeon: document.getElementById('surgeon').value.trim() || null,
                anesthesia_type: document.getElementById('anesthesiaType').value || null,
                
                // Assessment & Plan
                clinical_assessment: document.getElementById('clinicalAssessment').value.trim() || null,
                treatment_plan: document.getElementById('treatmentPlan').value.trim() || null,
                
                // System fields
                status: 'pre-op',
                created_by: currentUser.id,
                created_at: new Date().toISOString()
            };
            
            // Validation - only check required fields
            if (!patientData.name || !patientData.mrn || !patientData.age || !patientData.gender || !patientData.presenting_complaint) {
                showMessage('addPatientMessage', 'Please fill in all required fields (marked with *)', 'error');
                return;
            }
            
            // Validate MRN format (basic check)
            if (!/^[A-Z0-9]+$/i.test(patientData.mrn)) {
                showMessage('addPatientMessage', 'MRN should contain only letters and numbers', 'error');
                return;
            }
            
            // Show loading
            const originalContent = button.innerHTML;
            button.innerHTML = '<div class="loading"></div> Saving Complete Assessment...';
            button.disabled = true;
            
            try {
                const { data, error } = await supabase
                    .from('patients')
                    .insert([patientData])
                    .select();
                
                if (error) {
                    if (error.code === '23505') {
                        throw new Error('A patient with this MRN already exists');
                    }
                    throw error;
                }
                
                showMessage('addPatientMessage', `✅ Complete assessment for ${patientData.name} saved successfully!`, 'success');
                
                // Reset form after short delay
                setTimeout(() => {
                    form.reset();
                    // Reset admission date to today
                    document.getElementById('admissionDate').value = new Date().toISOString().split('T')[0];
                }, 1000);
                
                // Navigate back to patients list
                setTimeout(() => {
                    showPage('patients');
                    showNotification(`Patient ${patientData.name} added with complete assessment!`, 'success');
                }, 2500);
                
            } catch (error) {
                console.error('Error creating patient:', error);
                showMessage('addPatientMessage', 'Error creating patient: ' + error.message, 'error');
                
                // Reset button
                button.innerHTML = originalContent;
                button.disabled = false;
            }
        }

        function searchPatients(searchTerm) {
            if (!searchTerm.trim()) {
                displayPatients(allPatients);
                return;
            }
            
            const filtered = allPatients.filter(patient => {
                const searchString = `${patient.name} ${patient.mrn} ${patient.room_number} ${patient.surgery_type} ${patient.presenting_complaint}`.toLowerCase();
                return searchString.includes(searchTerm.toLowerCase());
            });
            
            displayPatients(filtered);
        }

function viewPatient(patientId) {
    // Find the patient in our cached data
    const patient = allPatients.find(p => p.id === patientId);
    if (!patient) {
        showNotification('Patient not found', 'error');
        return;
    }
    
    currentPatient = patient;
    loadPatientDetail(patient);
    showPage('patientDetail');
}

// Patient Detail Functions
function loadPatientDetail(patient) {
    try {
        // Populate patient header
        document.getElementById('detailPatientName').textContent = patient.name;
        document.getElementById('detailMRN').textContent = `MRN: ${patient.mrn}`;
        document.getElementById('detailAge').textContent = `Age: ${patient.age} years`;
        document.getElementById('detailGender').textContent = `Gender: ${patient.gender}`;
        document.getElementById('detailRoom').innerHTML = `<i class="fas fa-bed"></i> Room: ${patient.room_number || 'Not assigned'}`;
        document.getElementById('detailAdmissionDate').innerHTML = `<i class="fas fa-calendar-plus"></i> Admitted: ${formatDate(patient.admission_date)}`;
        document.getElementById('detailPhone').innerHTML = `<i class="fas fa-phone"></i> ${patient.phone || 'No contact'}`;
        
        // Populate status badge
        const statusClass = patient.status.replace('-', '');
        document.getElementById('detailStatus').innerHTML = `
            <span class="status ${statusClass}" style="font-size: 1.1rem; padding: 0.75rem 1.5rem;">
                <i class="fas ${getStatusIcon(patient.status)}"></i>
                ${getStatusText(patient.status)}
            </span>
        `;
        
        // Populate main content
        document.getElementById('detailPresentingComplaint').textContent = 
            patient.presenting_complaint || 'No presenting complaint recorded';
        document.getElementById('detailClinicalAssessment').textContent = 
            patient.clinical_assessment || 'No clinical assessment recorded';
        document.getElementById('detailTreatmentPlan').textContent = 
            patient.treatment_plan || 'No treatment plan recorded';
        
        // Medical History
        document.getElementById('detailPMH').textContent = 
            patient.past_medical_history || 'No past medical history recorded';
        document.getElementById('detailPSH').textContent = 
            patient.past_surgical_history || 'No past surgical history recorded';
        document.getElementById('detailAllergies').textContent = 
            patient.allergies || 'NKDA (No Known Drug Allergies)';
        document.getElementById('detailMedications').textContent = 
            patient.current_medications || 'No current medications recorded';
        document.getElementById('detailPhysicalExam').textContent = 
            patient.physical_exam || 'No physical examination findings recorded';
        
        // Quick Stats
        const daysAdmitted = patient.admission_date ? 
            Math.floor((new Date() - new Date(patient.admission_date)) / (1000 * 60 * 60 * 24)) : 0;
        document.getElementById('daysAdmitted').textContent = daysAdmitted;
        
        const surgeryDays = patient.surgery_date ? 
            Math.floor((new Date(patient.surgery_date) - new Date()) / (1000 * 60 * 60 * 24)) : null;
        const surgeryCountdown = document.getElementById('surgeryCountdown');
        
        if (surgeryDays !== null) {
            if (surgeryDays > 0) {
                surgeryCountdown.textContent = `In ${surgeryDays} days`;
                surgeryCountdown.style.color = 'var(--warning-amber)';
            } else if (surgeryDays === 0) {
                surgeryCountdown.textContent = 'Today';
                surgeryCountdown.style.color = 'var(--danger-red)';
            } else {
                surgeryCountdown.textContent = `${Math.abs(surgeryDays)} days ago`;
                surgeryCountdown.style.color = 'var(--success-green)';
            }
        } else {
            surgeryCountdown.textContent = 'Not scheduled';
            surgeryCountdown.style.color = 'var(--neutral-400)';
        }
        
        // Surgery Details
        document.getElementById('detailSurgeryType').textContent = 
            patient.surgery_type || 'Not scheduled';
        document.getElementById('detailSurgeryDate').textContent = 
            patient.surgery_date ? formatDate(patient.surgery_date) : 'Not scheduled';
        document.getElementById('detailSurgeryTime').textContent = 
            patient.surgery_time || 'Not scheduled';
        document.getElementById('detailSurgeon').textContent = 
            patient.surgeon || 'Not assigned';
        document.getElementById('detailAnesthesia').textContent = 
            patient.anesthesia_type || 'Not specified';
        
        // Lab Results
        const labs = [
            { name: 'Hemoglobin', value: patient.hemoglobin, unit: 'g/dL', normal: '12-16' },
            { name: 'WBC', value: patient.wbc, unit: '×10³/μL', normal: '4-11' },
            { name: 'Platelets', value: patient.platelets, unit: '×10³/μL', normal: '150-450' },
            { name: 'Creatinine', value: patient.creatinine, unit: 'mg/dL', normal: '0.7-1.3' },
            { name: 'BUN', value: patient.bun, unit: 'mg/dL', normal: '7-25' },
            { name: 'PSA', value: patient.psa, unit: 'ng/mL', normal: '<4.0' }
        ];
        
        document.getElementById('detailLabResults').innerHTML = labs.map(lab => `
            <div style="background: var(--neutral-50); border: 1px solid var(--neutral-200); border-radius: 0.5rem; padding: 0.75rem; text-align: center;">
                <div style="font-size: 0.8rem; color: var(--neutral-600); font-weight: 600; margin-bottom: 0.25rem;">${lab.name}</div>
                <div style="font-size: 1.1rem; color: var(--primary-blue); font-weight: 700; margin-bottom: 0.25rem;">${lab.value !== null ? lab.value : 'N/A'}</div>
                <div style="font-size: 0.75rem; color: var(--neutral-500);">${lab.value !== null ? lab.unit : ''}</div>
                <div style="font-size: 0.7rem; color: var(--neutral-500); margin-top: 0.25rem;">Normal: ${lab.normal}</div>
            </div>
        `).join('');
        
        // Additional Labs and Imaging
        document.getElementById('detailAdditionalLabs').textContent = 
            patient.lab_summary || 'No additional laboratory results recorded';
        document.getElementById('detailImaging').textContent = 
            patient.imaging_summary || 'No imaging studies recorded';
        
    } catch (error) {
        console.error('Error loading patient detail:', error);
        showNotification('Error loading patient details', 'error');
    }
}
        // Surgery Template Functions
        function fillSurgeryTemplate() {
            const surgeryType = document.getElementById('surgeryType').value;
            const assessmentField = document.getElementById('clinicalAssessment');
            const planField = document.getElementById('treatmentPlan');
            
            const templates = {
                'TURP': {
                    assessment: 'Benign prostatic hyperplasia (BPH) with urinary retention/LUTS. Enlarged prostate on DRE and imaging.',
                    plan: '1. TURP (Transurethral Resection of Prostate)\n2. Foley catheter post-op\n3. CBI (Continuous Bladder Irrigation)\n4. Monitor for bleeding, clot retention\n5. Trial of void when irrigation clear'
                },
                'URS': {
                    assessment: 'Ureteral/renal stone requiring endoscopic management. Stone size and location confirmed on imaging.',
                    plan: '1. Ureteroscopy with stone fragmentation\n2. Possible ureteral stent placement\n3. Post-op analgesia\n4. Follow-up imaging\n5. Stent removal in 2-4 weeks if placed'
                },
                'PCNL': {
                    assessment: 'Large renal stone (>2cm) or complex stone burden requiring percutaneous approach.',
                    plan: '1. Percutaneous nephrolithotomy\n2. Nephrostomy tube placement\n3. Monitor for bleeding, infection\n4. Post-op imaging\n5. Nephrostomy removal when appropriate'
                },
                'Circumcision': {
                    assessment: 'Phimosis/paraphimosis or recurrent balanitis requiring circumcision.',
                    plan: '1. Circumcision procedure\n2. Post-op wound care instructions\n3. Pain management\n4. Follow-up in 1-2 weeks\n5. Activity restrictions'
                },
                'Nephrectomy': {
                    assessment: 'Renal mass/malignancy or non-functioning kidney requiring surgical removal.',
                    plan: '1. Radical/Partial nephrectomy\n2. Post-op pain management\n3. Monitor renal function\n4. Drain management\n5. Oncology follow-up if malignant'
                },
                'Cystoscopy': {
                    assessment: 'Hematuria, bladder mass, or urethral pathology requiring cystoscopic evaluation.',
                    plan: '1. Diagnostic cystoscopy\n2. Possible biopsy/resection\n3. Post-procedure monitoring\n4. Follow-up based on findings\n5. Pathology review if tissue obtained'
                },
                'Prostatectomy': {
                    assessment: 'Localized prostate cancer requiring radical surgical treatment.',
                    plan: '1. Radical prostatectomy (open/laparoscopic/robotic)\n2. Foley catheter 7-14 days\n3. Monitor for bleeding, infection\n4. PSA monitoring\n5. Oncology follow-up'
                }
            };
            
            if (templates[surgeryType]) {
                if (assessmentField.value.trim() === '') {
                    assessmentField.value = templates[surgeryType].assessment;
                }
                if (planField.value.trim() === '') {
                    planField.value = templates[surgeryType].plan;
                }
                showNotification(`✨ Template loaded for ${surgeryType}`, 'info');
            }
        }

        // Initialize form defaults
        function initializeAddPatientForm() {
            // Set admission date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('admissionDate').value = today;
        }

        // Utility Functions
        function getStatusIcon(status) {
            switch(status) {
                case 'pre-op': return 'fa-clock';
                case 'post-op': return 'fa-procedures';
                case 'discharged': return 'fa-home';
                default: return 'fa-question';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'pre-op': return 'Pre-Operative';
                case 'post-op': return 'Post-Operative';
                case 'discharged': return 'Discharged';
                default: return status;
            }
        }

        function formatDate(dateString) {
            if (!dateString) return null;
            return new Date(dateString).toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
        }

        function formatSurgeryDateTime(date, time) {
            if (!date) return 'Not scheduled';
            const formattedDate = formatDate(date);
            const formattedTime = time ? ` at ${time}` : '';
            return `Surgery: ${formattedDate}${formattedTime}`;
        }

        function updateStatistics(patients) {
            const stats = { 'pre-op': 0, 'post-op': 0, 'discharged': 0 };
            patients.forEach(patient => {
                if (stats.hasOwnProperty(patient.status)) {
                    stats[patient.status]++;
                }
            });
            
            document.getElementById('preOpCount').textContent = stats['pre-op'];
            document.getElementById('postOpCount').textContent = stats['post-op'];
            document.getElementById('dischargedCount').textContent = stats['discharged'];
        }

        function updateNavigationForUser(user) {
            document.getElementById('loginNavBtn').style.display = 'none';
            document.getElementById('patientsNavBtn').style.display = 'inline-flex';
            document.getElementById('logoutNavBtn').style.display = 'inline-flex';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('userEmailDisplay').textContent = user.email;
        }

        function updateNavigationForGuest() {
            document.getElementById('loginNavBtn').style.display = 'inline-flex';
            document.getElementById('patientsNavBtn').style.display = 'none';
            document.getElementById('logoutNavBtn').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
        }

        function getErrorMessage(errorMessage) {
            if (errorMessage.includes('Invalid login credentials')) {
                return 'Invalid email or password. Please check your credentials.';
            } else if (errorMessage.includes('Too many requests')) {
                return 'Too many attempts. Please try again later.';
            } else {
                return errorMessage;
            }
        }

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `auth-message ${type}`;
            element.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => element.style.display = 'none', 3000);
            }
        }

        function showNotification(message, type = 'info') {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas ${getNotificationIcon(type)}" style="color: ${getNotificationColor(type)};"></i>
                    <span style="color: ${getNotificationTextColor(type)};">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="notification-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            notification.style.borderLeft = `4px solid ${getNotificationColor(type)}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'fa-check-circle';
                case 'error': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                default: return 'fa-info-circle';
            }
        }

        function getNotificationColor(type) {
            switch(type) {
                case 'success': return 'var(--success-green)';
                case 'error': return 'var(--danger-red)';
                case 'warning': return 'var(--warning-amber)';
                default: return 'var(--primary-blue)';
            }
        }

        function getNotificationTextColor(type) {
            switch(type) {
                case 'success': return '#065f46';
                case 'error': return '#991b1b';
                case 'warning': return '#92400e';
                default: return 'var(--neutral-700)';
            }
        }

        // Supabase Auth State Listener
        supabase.auth.onAuthStateChange((event, session) => {
            console.log('🔐 Auth state changed:', event, session?.user?.email);
            
            if (session?.user) {
                currentUser = session.user;
                isLoggedIn = true;
                updateNavigationForUser(session.user);
                showPage('patients');
            } else {
                currentUser = null;
                isLoggedIn = false;
                updateNavigationForGuest();
                showPage('login');
            }
        });

        // App Initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🏥 Urology App (Enhanced Assessment) loaded successfully!');
            
            // Initialize page state
            showPage('login');
            updateNavigationForGuest();
            initializeAddPatientForm();
            
            // Check existing session
            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session?.user) {
                    console.log('✅ User already logged in:', session.user.email);
                }
            });
        });
    </script>
</body>
</html>
